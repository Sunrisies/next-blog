å›è°ƒåœ°ç‹±æ˜¯æŒ‡åœ¨ JavaScript ä¸­ä½¿ç”¨å›è°ƒå‡½æ•°çš„åµŒå¥—è¿‡å¤šï¼Œå¯¼è‡´ä»£ç éš¾ä»¥ç»´æŠ¤å’Œç†è§£çš„æƒ…å†µã€‚ç›¸ä¿¡å¾ˆå¤šåŒå­¦å°±è§è¿‡å¦‚ä¸‹å¯¹å›è°ƒåœ°ç‹±çš„è°ƒä¾ƒï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2b625e28b3a4bc3bc4042459d53a7b1~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=721&h=420&s=253091&e=png&b=1f1e1e)

åœ¨çœŸå®çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œè¿™æ ·çš„å†™æ³•å±¡è§ä¸é²œï¼Œè€Œå¾€å¾€ä½œè€…çš„è§£é‡Šéƒ½æ˜¯â€œé€»è¾‘å¤æ‚ï¼Œè€Œä¸”å…¨æ˜¯å¼‚æ­¥â€ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ`Promise` è¢«å¼•å…¥åˆ° JavaScript ä¸­ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´ä¼˜é›…çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥æ“ä½œã€‚å› æ­¤å¯ä»¥è¯´ï¼Œ**Promise å°±æ˜¯å›è°ƒåœ°ç‹±çš„çµä¸¹å¦™è¯**ï¼Œæœ¬æ–‡æˆ‘ä»¬æ¥è¯¦ç»†è®¨è®º Promiseã€‚

Promise åŸç†
----------

æœ€æ—©çš„ Promise å®ç°æ˜¯ç”± CommonJS ç¤¾åŒºçš„ _Kris Kowal_ äº 2010 å¹´åˆ›å»ºçš„ Q åº“ï¼Œç°åœ¨åœ¨ GitHub ä¸Šè¿˜èƒ½æ‰¾åˆ°ï¼š[github.com/kriskowal/q](https://github.com/kriskowal/q "https://github.com/kriskowal/q")ã€‚

2012 å¹´ï¼Œ`Promises/A` è§„èŒƒè¢«æå‡ºï¼Œæ—¨åœ¨å¯¹ Promise å¯¹è±¡çš„è¡Œä¸ºå’Œæ¥å£è¿›è¡Œæ ‡å‡†åŒ–ã€‚Promises/A è§„èŒƒå®šä¹‰äº† Promise å¯¹è±¡çš„åŸºæœ¬è¡Œä¸ºï¼Œä»¥ç¡®ä¿ä¸åŒ Promise å®ç°ä¹‹é—´çš„äº’æ“ä½œæ€§ã€‚

éšç€ ES6 æ ‡å‡†çš„åˆ¶å®šï¼ŒPromise å¯¹è±¡åœ¨ 2015 å¹´è¢«æ­£å¼çº³å…¥ JavaScript è¯­è¨€ä¸­ã€‚ES6 ä¸­çš„ Promise å¯¹è±¡åŸºäº Promises/A+ è§„èŒƒï¼Œå¹¶æä¾›äº†ä¸€ç»„å†…ç½®çš„æ–¹æ³•å’Œè¯­æ³•ç³–ï¼Œä½¿å…¶æ›´æ˜“äºä½¿ç”¨ã€‚

> ğŸ’¡ æ—¶è‡³ä»Šæ—¥ï¼ŒES6 ä¹‹å‰çš„ç¤¾åŒºå¼€æº Promise åº“ï¼Œæ¯”å¦‚ [Q](http://npm.im/q "http://npm.im/q")ã€[promise](http://npm.im/promise "http://npm.im/promise")ã€[bluebird](http://npm.im/bluebird "http://npm.im/bluebird")ï¼Œæ¯å‘¨ä»æœ‰ä¸€ä¸¤åƒä¸‡çš„ä¸‹è½½é‡ã€‚

é‚£ä¹ˆ Promise åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿæ³¨æ„äº†ï¼Œä¸‹é¢å¸¸å¸¸æ˜¯é¢è¯•å®˜è¦è€ƒå¯Ÿçš„å†…å®¹ä¹‹ä¸€ã€‚

Promise å¯¹è±¡æœ‰ä¸‰ç§çŠ¶æ€ï¼š`pending`ï¼ˆè¿›è¡Œä¸­ï¼‰ã€`fulfilled`ï¼ˆå·²æˆåŠŸï¼‰å’Œ `rejected`ï¼ˆå·²å¤±è´¥ï¼‰ã€‚å½“ä¸€ä¸ª Promise å¯¹è±¡å¤„äº `pending` çŠ¶æ€æ—¶ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ `resolve` å‡½æ•°å°†å…¶çŠ¶æ€æ”¹ä¸º `fulfilled`ï¼Œæˆ–è€…é€šè¿‡è°ƒç”¨ `reject` å‡½æ•°å°†å…¶çŠ¶æ€æ”¹ä¸º `rejected`ã€‚ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¼šè°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6d3fc739adf49cea17729c6c86d2f1d~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1764&h=684&s=105019&e=png&b=fefcfc)

`fulfilled` ä¸ `rejected` åˆç»Ÿä¸€ç§°ä¸º `settled`ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº† Promise çš„åŸºæœ¬ç”¨æ³•ï¼š

    const promise = new Promise((resolve, reject) => {
      // å¼‚æ­¥æ“ä½œ
      setTimeout(() => {
        const randomNum = Math.random();
        if (randomNum < 0.5) {
          resolve(randomNum);
        } else {
          reject(Error());
        }
      }, 200);
    });
    
    promise.then((result) => {
      console.log('Fulfilled:', result);
    }).catch((error) => {
      console.log('Rejected:', error);
    });
    

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå®ƒä¼šåœ¨ 200ms åè¿”å›ä¸€ä¸ªéšæœºæ•°ã€‚å¦‚æœå°äº 0.5ï¼ŒPromise çš„çŠ¶æ€å°†å˜ä¸º fulfilledï¼Œå¹¶è°ƒç”¨ then å›è°ƒå‡½æ•°ï¼›å¦‚æœå¤§äºç­‰äº 0.5ï¼ŒPromise çš„çŠ¶æ€å°†å˜ä¸º rejectedï¼Œå¹¶è°ƒç”¨ catch å›è°ƒå‡½æ•°ã€‚

é€šè¿‡ä½¿ç”¨ Promiseï¼Œæˆ‘ä»¬å¯ä»¥é¿å…å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå°†å¼‚æ­¥æ“ä½œçš„åµŒå¥—æ”¹ä¸ºé“¾å¼è°ƒç”¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Promise è§£å†³å›è°ƒåœ°ç‹±é—®é¢˜çš„ç¤ºä¾‹ï¼š

    function asyncOperation1() {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve('Operation 1');
        }, 1000);
      });
    }
    
    function asyncOperation2() {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve('Operation 2');
        }, 1000);
      });
    }
    
    function asyncOperation3() {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve('Operation 3');
        }, 1000);
      });
    }
    
    asyncOperation1()
      .then((result1) => {
        console.log(result1);
        return asyncOperation2();
      })
      .then((result2) => {
        console.log(result2);
        return asyncOperation3();
      })
      .then((result3) => {
        console.log(result3);
      })
      .catch((error) => {
        console.log(error);
      });
    

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªå¼‚æ­¥æ“ä½œå‡½æ•° asyncOperation1ã€asyncOperation2 å’Œ asyncOperation3ï¼Œå®ƒä»¬åˆ†åˆ«è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚é€šè¿‡ä½¿ç”¨ then æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›å¼‚æ­¥æ“ä½œä¸²è”èµ·æ¥ï¼Œä»¥ä¾¿æŒ‰é¡ºåºæ‰§è¡Œã€‚å¦‚æœä»»ä½•ä¸€ä¸ªå¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œå°†ä¼šè°ƒç”¨ catch æ–¹æ³•å¤„ç†é”™è¯¯ã€‚

äº‹å®ä¸Šï¼Œä¹Ÿå¯ä»¥ä¸æŒ‰ç…§å¹¶è”è€Œæ˜¯`ä¸²è”`çš„æ–¹å¼ï¼š

    const op1 = asyncOperation1();
    op1.catch((error) => {
        console.log(error);
      });
    op1.then(() => {
        return asyncOperation2();
      })
      .catch((error) => {
        console.log(error);
      });
    op1.then(() => {
        return asyncOperation3();
      })
      .catch((error) => {
        console.log(error);
      });
    

å› æ­¤ï¼Œå¯ä»¥æƒ³è±¡å¤šä¸ª Promise å¯¹è±¡ä¹‹é—´å¯ä»¥æ„æˆä¸€ä¸ªå¤šå‰æ ‘ç»“æ„ï¼Œé‚£ä¹ˆè¿™ç§ç¥å¥‡çš„ API æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

å…¶å®ï¼Œåœ¨ Promise å¯¹è±¡å†…éƒ¨ï¼Œä¼šå­˜åœ¨ä¸¤ä¸ªåˆ†åˆ«å«åš `[[PromiseFulfillReactions]]` å’Œ `[[PromiseRejectReactions]]` çš„åˆ—è¡¨ï¼Œå­˜å‚¨çš„å°±æ˜¯ then å’Œ catch çš„å‚æ•°ã€‚

äºæ˜¯ï¼Œåœ¨ä¸€ä¸ª Promise ä¸Šå¤šæ¬¡è°ƒç”¨ then å’Œ catchï¼Œå®ƒä»¬çš„å‚æ•°å°±éƒ½ä¼šå­˜å‚¨åœ¨è¿™ä¸¤ä¸ªåˆ—è¡¨ä¸­ï¼Œç­‰åˆ° Promise ä» `pending` å˜ä¸º `fulfilled` æˆ– `rejected`ï¼Œå†ä¾æ¬¡å–å‡ºåˆ—è¡¨ä¸­çš„å‡½æ•°æ¥è°ƒç”¨ã€‚

å¦‚æœ Promise å·²ç»æ˜¯ fulfilled æˆ– rejected çŠ¶æ€ï¼Œé‚£ä¹ˆè°ƒç”¨ then å’Œ catch å°±ä¸å¿…å†å’Œé‚£ä¸¤ä¸ªåˆ—è¡¨æ‰“äº¤é“äº†ã€‚å› æ­¤ `[[PromiseFulfillReactions]]` å’Œ `[[PromiseRejectReactions]]` æ˜¯å……å½“ä¸€ä¸ªç¼“å­˜çš„è§’è‰²ã€‚

![image.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1eceedefb8e49548d71c9afcf8e19ec~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1376&h=1138&s=50268&e=jpg&b=faf4f2)

å¦å¤–ï¼Œthen å’Œ catch ä¹‹åå¯ä»¥ç»§ç»­é“¾å¼è°ƒç”¨ then æˆ– catchï¼Œå¯ä»¥æƒ³åˆ°å®ƒä»¬æ˜¯è¿”å›äº†ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚

å®ç°ä¸€ä¸ª Promise
------------

æ ¹æ®ä»¥ä¸ŠåŸç†åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•è‡ªè¡Œå®ç°ä¸€ä¸ª Promiseã€‚è¿™ä¸ªè¿‡ç¨‹æœ‰åŠ©äºä½ æ›´æ·±å…¥ç†è§£ Promiseï¼Œå¹¶ä¸”æ³¨æ„ï¼Œè¿™ä¹Ÿå¸¸å¸¸æ˜¯ä¸€é“é¢è¯•é¢˜å“¦ï½

æˆ‘ä»¬ç”¨ TypeScript ç¼–å†™ï¼Œå…ˆå®šä¹‰å‡ ä¸ªç±»å‹ï¼š

    type FulfillReaction<T> = (value: T) => void;
    
    type RejectReaction = (reason: Error) => void;
    
    type Executor<T> = (resolve: FulfillReaction<T>, reject?: RejectReaction) => void;
    
    enum State {
        pending = 'pending',
        fulfilled = 'fulfilled',
        rejected = 'rejected'
    }
    

å…¶ä¸­ `FulfillReaction` å³ resolve å‡½æ•°ï¼Œä¸åŒéœ€æ±‚ä¸‹å®ƒçš„å‚æ•°ç±»å‹ä¹Ÿä¸åŒï¼Œå› æ­¤æˆ‘ç”¨äº†ä¸€ä¸ªèŒƒå‹ã€‚`RejectReaction` å³ reject å‡½æ•°ï¼Œæˆ‘ä»¬æš‚ä¸”è®¤å®šå…¶å‚æ•°å°±æ˜¯ä¸€ä¸ª Errorï¼Œå®é™…ä¸Šå¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œç”šè‡³ undefinedã€‚

`Executor` æ˜¯ Promise å¿…ä¼ çš„æ„é€ å‚æ•°ï¼Œå…¶ 2 ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ `FulfillReaction` å’Œ `RejectReaction`ï¼Œå› æ­¤å®ƒä¹Ÿå…·æœ‰èŒƒå‹ç‰¹å¾ã€‚

`State` ä¸å¿…å¤šè¯´ï¼Œæšä¸¾å€¼æ˜ å°„çš„æ˜¯å‰é¢æˆ‘ä»¬æåˆ°çš„ Promise çš„ä¸‰ä¸ªçŠ¶æ€ã€‚

æ¥ä¸‹æ¥å®šä¹‰ Promise ç±»æ¡†æ¶ï¼š

    class MyPromise<T = any> {
        #state: State = State.pending;
    
        #fulfillReactions: FulfillReaction<T>[] = [];
        #rejectReactions: RejectReaction[] = [];
    
        #result: T | Error | undefined = undefined;
    
        constructor(executor: Executor<T>) {
            if ('function' !== typeof executor) {
                throw TypeError('Promise executor is not a function');
            }
        }
    
        public then(fulfillReaction?: FulfillReaction<T>, rejectReaction?: RejectReaction): MyPromise<T> {}
        
        public catch(rejectReaction?: RejectReaction): MyPromise<T> {}
    

å…¶ä¸­ `#fulfillReactions` å’Œ `#rejectReactions` åˆ†åˆ«ä»£è¡¨ ECMAScript ä¸­çš„ `[[PromiseFulfillReactions]]` æˆ– `[[PromiseRejectReactions]]`ã€‚åœ¨æ„é€ å‡½æ•°ä¸­æˆ‘ç‰¹æ„æ ¡éªŒäº† **executor** çš„ç±»å‹ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼ŒçœŸå® Promise çš„å®ç°ä¹Ÿæœ‰è¿™ä¸€æ­¥ã€‚

å¤§å®¶éœ€è¦ç‰¹åˆ«å…³æ³¨çš„æ˜¯ `then` å’Œ `catch` çš„å®šä¹‰ï¼Œå®ƒä»¬çš„å‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”**ä¸€å®šè¿”å›ä¸€ä¸ªç›¸åŒèŒƒå‹çš„ Promise å¯¹è±¡**ã€‚

å¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç° Promise çš„å…³é”®é€»è¾‘ï¼Œé¦–å…ˆæ˜¯è¿è¡Œ **executor**ï¼Œè¿™ä¸€æ­¥åœ¨æ„é€ å‡½æ•°ä¸­ç›´æ¥**åŒæ­¥**æ‰§è¡Œï¼š

    class MyPromise<T> {
        constructor(executor: Executor<T>) {
            executor((value: T) => {
                this.#result = value;
                this.#state = State.fulfilled;
                for (const react of this.#fulfillReactions) {
                    react(value);
                }
            }, (reason: Error) => {
                this.#result = reason;
                this.#state = State.rejected;
                for (const react of this.#rejectReactions) {
                    react(reason);
                }
            });
        }
    }
    

æ— è®ºæœ€åèµ°åˆ° `fulfilled` è¿˜æ˜¯ `rejected`ï¼Œæˆ‘ä»¬éƒ½æŠŠç»“æœä¿å­˜åˆ° `#result` ä¸­ï¼Œä»¥å¤‡åé¢å†ç”¨åˆ°ã€‚

ç„¶åå…³é”®çš„ä¸€ç‚¹ï¼Œä¸¤ä¸ªå›è°ƒå‡½æ•°ä¸­éƒ½éœ€è¦éå†æ‰§è¡Œ `#fulfillReactions` æˆ– `#rejectReactions` çš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å‡è®¾ä¸¤ä¸ªåˆ—è¡¨ä¸­çš„å‡½æ•°éƒ½æ˜¯é€šè¿‡ `then` æˆ– `catch` åŠ å…¥è¿›å»çš„ã€‚

é‚£ä¹ˆè¿™é‡Œå°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœ **executor** æ˜¯åŒæ­¥è°ƒç”¨ resolve æˆ– reject çš„ï¼Œé‚£ä¹ˆ Promise æ ¹æœ¬æ¥ä¸åŠè°ƒç”¨ `then` æˆ– `catch` å°±ä» **pending** è¿›å…¥ `fulfilled` æˆ– `rejected` äº†ï¼Œ`#fulfillReactions` å’Œ `#rejectReactions` ä¸€å®šéƒ½æ˜¯ç©ºåˆ—è¡¨ã€‚

å› æ­¤ï¼ŒçœŸå®çš„åšæ³•æ˜¯å°† `#fulfillReactions` å’Œ `#rejectReactions` çš„å‡½æ•°æ”¾åˆ°å¼‚æ­¥çš„äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œï¼Œä¸æ˜¯åŒæ­¥çš„ï¼Œå› æ­¤æˆ‘æ”¹å†™æˆï¼š

    class MyPromise<T> {
        constructor(executor: Executor<T>) {
            executor((value: T) => {
                this.#result = value;
                this.#state = State.fulfilled;
                process.nextTick(() => {
                    for (const react of this.#fulfillReactions) {
                        process.nextTick(() => react(value));
                    }
                });
            }, (reason: Error) => {
                this.#result = reason;
                this.#state = State.rejected;
                process.nextTick(() => {
                    for (const react of this.#rejectReactions) {
                        process.nextTick(() => react(reason));
                    }
                });
            });
        }
    }
    

æˆ‘ä½¿ç”¨åˆ°äº† Node.js ä¸­çš„ `process.nextTick` æ¥å®ç°å¼‚æ­¥ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨å¤§å®¶æ›´è€³ç†Ÿèƒ½è¯¦çš„ setTimeoutï¼Œè¿™æ˜¯æœ‰åŸå› çš„ï¼Œè¿™é‡Œå…ˆåŸ‹ä¸‹ä¸€ä¸ªä¼ç¬”ï¼Œæˆ‘ä¼šåœ¨é«˜çº§ç¯‡ä¸­è¯¦ç»†è®²åˆ°å…¶ä¸­çš„å…³é”®çŸ¥è¯†ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç° `then` å‡½æ•°ã€‚è°ƒç”¨æ­¤å‡½æ•°çš„æ—¶å€™ï¼ŒPromise å¯¹è±¡å¯èƒ½å¤„äº `pending` çŠ¶æ€ï¼Œä¹Ÿå¯èƒ½å¤„äº `fulfilled` æˆ– `rejected` çŠ¶æ€ã€‚å‰è€…ï¼Œæˆ‘ä»¬è¿˜ä¸çŸ¥é“ç»“æœï¼Œéœ€è¦ç­‰å¾…ï¼Œåè€…æˆ‘ä»¬çŸ¥é“äº†ç»“æœã€‚æ— è®ºå“ªä¸€ç§ï¼Œ`then` éƒ½éœ€è¦è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚

å…ˆæ¥å®ç° `fulfilled` å’Œ `rejected`ï¼š

    if (this.#state === State.fulfilled) {
        return new MyPromise<T>((resolve) => {
            resolve(this.#result as T);
        });
    }
    
    if (this.#state === State.rejected) {
        return new MyPromise<T>((resolve, reject) => {
            reject(this.#result as Error);
        });
    }
    

ç¬¬ä¸€éçœ‹ä¸æ‡‚çš„åŒå­¦è¯·åœ¨ä»”ç»†å“ä¸€å“ï¼Œç¬¬äºŒéè¿˜çœ‹ä¸æ‡‚çš„è¯å¯ä»¥ç»™æˆ‘ç•™è¨€ã€‚

æ¥ä¸‹æ¥ï¼Œå¦‚æœé‡åˆ° `pending`ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å‘ `#fulfillReactions` æˆ– `#rejectReactions` æ³¨å†Œå‡½æ•°ï¼Œè¿™æ · Promise çŠ¶æ€å˜æ›´ä¹‹æ—¶æˆ‘ä»¬èƒ½å¾—åˆ°é€šçŸ¥ï¼š

    if (this.#state === State.pending) {
        return new MyPromise<T>((resolve, reject) => {
            const tmpFulfillReaction = (value: T): void => {
                fulfillReaction?.(value);
                resolve(value);
            };
            this.#fulfillReactions.push(tmpFulfillReaction);
            
            const tmpRejectReaction = (reason: Error): void => {
                rejectReaction?.(reason);
                reject(reason);
            };
            this.#rejectReactions.push(tmpRejectReaction);
        });
    }
    

è¿™é‡Œæˆ‘ç”¨ä¸¤ä¸ªä¸´æ—¶å˜é‡ï¼ŒtmpFulfillReaction å’Œ tmpRejectReactionï¼Œåˆ†åˆ«èšåˆäº† then çš„å‚æ•°å’Œæ–° Promise å¯¹è±¡çš„ resolve/rejectã€‚

æœ€å `catch` å®ç°èµ·æ¥æ›´ç®€å•äº†ï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ `then` çš„å˜å½¢ï¼š

    public catch(rejectReaction?: RejectReaction): MyPromise<T> {
        return this.then(undefined, rejectReaction);
    }
    

ä»¥ä¸Šå°±æ˜¯æœ€åŸºæœ¬çš„ Promise å®ç°ï¼Œå¤§å®¶å¯ä»¥æŠŠå®Œæ•´ä»£ç æ•´ç†å‡ºæ¥ï¼Œè¯•ä¸€è¯•ä¸‹é¢è¿™ä¸ªä¾‹å­èƒ½å¦æ­£å¸¸è¿è¡Œï¼š

    new MyPromise((resolve) => {
        resolve(1);
    })
    .then((result) => { throw Error(`${result}`) })
    .catch((err) => console.log(err));
    

å½“ç„¶ï¼ŒçœŸå®çš„ Promise é€»è¾‘è¦æœ‰æ›´å¤šçš„ç»†èŠ‚å’ŒåŠŸèƒ½ï¼Œæ¯”å¦‚ ES2018 å¼•å…¥çš„ `finally` å‡½æ•°ï¼Œç»™å¤§å®¶ç•™ä¸€ä¸ªä½œä¸šï¼šåŸºäºä»¥ä¸Šä»£ç ï¼Œè¡¥å…… finally çš„å®ç°ã€‚

é™¤äº† Promise å®ä¾‹çš„æ–¹æ³•ï¼Œå®ƒçš„é™æ€æ–¹æ³•ä¹Ÿå¾ˆå¸¸ç”¨ï¼Œç”šè‡³æœ‰æ—¶æ‰®æ¼”äº†å¾ˆé‡è¦çš„è§’è‰²ã€‚

Promise é™æ€æ–¹æ³•
------------

Promise é™æ€æ–¹æ³•åŒ…æ‹¬ `resolve/reject/all/race/allSettled/any`ã€‚å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯ä¸ºäº†æ“ä½œæ•ˆç‡è€Œè®¾è®¡ï¼Œå› æ­¤å¦‚æœç†è§£å…¶åŸç†çš„è¯ï¼Œä¹Ÿèƒ½è‡ªè¡Œå®ç°ï¼Œç”šè‡³æ‹“å±•æ›´å¤šåŠŸèƒ½ã€‚

`Promise.resolve` å°†å‚æ•°è½¬æ¢ä¸º Promise çš„å½¢æ€ï¼Œç”¨ä»£ç æè¿°å¯èƒ½æ›´å®¹æ˜“ç†è§£ï¼š

    Promise.resolve  = (result) => new Promise(resolve => resolve(result));
    

å½“ç„¶ï¼Œå¦‚æœå‚æ•°æœ¬èº«å°±æ˜¯ä¸€ä¸ª Promiseï¼Œé‚£ä¹ˆé“¾ä¸Šå»å°±è¡Œäº†ï¼Œå› æ­¤å…¶æœ€ç»ˆä¹Ÿå¹¶éä¸€å®šèµ°åˆ° `then`ï¼š

    Promise.resolve(new Promise((resolve, reject) => throw Error()))
    .catch(err => console.error(err)); // æœ€ç»ˆä¼š catch
    

å½“ä½ éœ€è¦ä¸€ä¸ª Promiseï¼Œ ä½†å‚æ•°å¯èƒ½æ˜¯ Promise ä¹Ÿå¯èƒ½ä¸æ˜¯çš„æ—¶å€™ï¼Œæœ€é€‚åˆç”¨æ­¤æ–¹æ³•ã€‚ç±»ä¼¼çš„è¿˜æœ‰ `Promise.reject`ï¼Œä¸å†èµ˜è¿°ã€‚

å‰©ä¸‹çš„ 4 ä¸ªé™æ€å‡½æ•°éƒ½æ˜¯å¤„ç†å¹¶è¡Œ Promise çš„ï¼Œå‚æ•°éƒ½æ˜¯è¿­ä»£å™¨ï¼Œè¿­ä»£é¡¹å¯ä»¥ä¸æ˜¯ Promiseï¼ˆä½†ä¼šç”¨ `Promise.resolve` è½¬æ¢ä¸º Promiseï¼‰ï¼Œè¿”å›å€¼éƒ½æ˜¯æ–°çš„ Promise å¯¹è±¡ï¼Œå…¶ resolve æˆ– reject çš„æ—¶æœºæ ¹æ®ä¸åŒçš„ä»»åŠ¡éœ€æ±‚å„è‡ªè®¾è®¡ã€‚

`Promise.all` æœŸæœ›æ‰€æœ‰å‚æ•°éƒ½ä¼šèµ°åˆ° `fulfilled`ï¼Œå“ªæ€•æœ‰ä¸€ä¸ªè¿›å…¥ `rejected`ï¼Œè¿”å›çš„ Promise å¯¹è±¡å°±ä¼š rejectedã€‚

æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªé¡µé¢ï¼Œéœ€è¦å¹¶è¡Œè¯·æ±‚å¤šä¸ªåç«¯æ¥å£ï¼Œå¹¶ä¸”å®ƒä»¬ä¸å¯ä»¥å¤±è´¥ï¼Œé‚£ä¹ˆå°±å¾ˆé€‚åˆ `Promise.all`ã€‚æˆ‘ä»¬è¯•ä¸€è¯•å†™ä¸€ä¸‹å®ƒçš„åŸç†ä»£ç ï¼š

    Promise.all = (promises) => {
        return new Promise((resolve, reject) => {
            const results = new Array(promises.length);
            let fulfilledCount = 0;
            for (let i = 0; i < promises.length; i += 1) {
                Promise.resolve(p).then(
                    (result) => {
                        results[i] = result;
                        fulfilledCount += 1;æ£€æŸ¥
                        // è®¡æ•°
                        if (fulfilledCount === promises.length) resolve(results);
                    },
                    // â€œçŸ­è·¯â€æ•ˆåº”
                    reject
                );
            }
        });
    };
    

> ğŸ’¡ è¿™ä¹Ÿæ˜¯ä¸€é“å¸¸è§çš„é¢è¯•é¢˜ï¼Œä½ èµ·ç è¦ä¿è¯ resolve å’Œ reject æ—¶æœºçš„æ­£ç¡®æ€§ï¼ŒåŠ åˆ†é¡¹æ˜¯ resultsã€é Promise å‚æ•°å¤„ç†ç­‰ç»†èŠ‚ã€‚

ä¸ä¹‹ç›¸è¿‘çš„æ˜¯ `Promise.allSettled`ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯æ°¸è¿œä¸ä¼šèµ°åˆ° rejectedï¼Œå®ƒä¼šæŠŠæ‰€æœ‰ Promise çš„ç»“æœæ”¶é›†èµ·æ¥ï¼Œæ— è®ºæ˜¯ fulfilled è¿˜æ˜¯ rejectedï¼š

    // [
    //   { status: 'fulfilled', value: 1 },
    //   { status: 'rejected', reason: 1 }
    // ]
    Promise.allSettled([
        Promise.resolve(1),
        Promise.reject(1)
    ]).then(console.log);
    

> ğŸ’¡ æ³¨æ„å…¶ç»“æœçš„ç»“æ„ã€‚

ä¸ Promise.all ç›¸åçš„æ˜¯ `Promise.any`ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯ä»»ä½•ä¸€ä¸ª Promise è¿›å…¥ fulfilledï¼Œå®ƒè¿”å›çš„ Promise åˆ™ç«‹å³ fulfilledï¼Œå¦åˆ™ç­‰åˆ°æ‰€æœ‰ Promise è¢« rejectedï¼Œå®ƒä¼šæŠ›å‡ºä¸€ä¸ª `AggregateError`ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡ï¼Œ`Promise.any` æ˜¯ ECMAScript è§„èŒƒä¸­å”¯ä¸€ä¸€ä¸ªèƒ½äº§ç”Ÿ AggregateError çš„æ–¹æ³•ã€‚

`Promise.any` è¿˜å¾ˆæ–°ï¼Œåº”å½“æ³¨æ„å…¶æµè§ˆå™¨å…¼å®¹æ€§ï¼Œä½ å¯ä»¥è‡ªè¡Œå®ç°ï¼š

    Promise.any = (promises) => {
        return new Promise((resolve, reject) => {
            const results = new Array(promises.length);
            let rejectedCount = 0;
            for (let i = 0; i < promises.length; i += 1) {
                Promise.resolve(p).then(
                    // â€œçŸ­è·¯â€æ•ˆåº”
                    resolve,
                    (result) => {
                        results[i] = result;
                        rejectedCount += 1;æ£€æŸ¥
                        // è®¡æ•°
                        if (rejectedCount === promises.length)
                            reject(AggregateError(results));
                    }
                );
            }
        });
    };
    

æœ€åä¸€ä¸ªæ˜¯ `Promise.race`ï¼Œå®ƒç›¸æ¯”äº all å’Œ anyï¼Œå…·æœ‰å…¨é¢çš„çŸ­è·¯æ•ˆåº”ï¼Œå³ä»»æ„ Promise ä» pending è¿›å…¥ fulfilled æˆ– rejectedï¼Œå®ƒè¿”å›çš„ Promise ä¹Ÿç«‹å³è¿›å…¥ç›¸åº”çŠ¶æ€ï¼Œå¿½ç•¥æ›´æ…¢çš„å…¶ä»– Promiseã€‚

    Promise.race = (promises) => {
        return new Promise((resolve, reject) => {
            for (let i = 0; i < promises.length; i += 1) {
                Promise.resolve(p).then(
                    resolve,
                    reject
                );
            }
        });
    };
    

å¯¹åŒä¸€ä¸ª Promise å¯¹è±¡è€Œè¨€ï¼Œé‡å¤è°ƒç”¨ resolve æˆ– reject æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå“ªä¸ª Promise æ›´å¿«ï¼Œå“ªä¸ªå°±èƒ½â€œå‡ºåœˆâ€ï¼Œå‘å¤–è¾“å‡ºè‡ªå·±çš„ç»“æœï¼ˆæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ï¼Œæ‰€ä»¥å«åš raceï¼ˆç«èµ›ï¼‰ã€‚

æ€»ç»“ä¸€ä¸‹è¿™ 4 ä¸ªé™æ€æ–¹æ³•çš„ç‰¹ç‚¹ï¼š

API

fulfilled çŸ­è·¯

rejected çŸ­è·¯

all

âŒ

âœ…

any

âœ…

âŒ

allSettled

âŒ

âŒ

race

âœ…

âœ…

å°ç»“
--

æœ¬æ–‡æˆ‘ä»¬ä»å›è°ƒåœ°ç‹±åˆ‡å…¥ï¼Œåœ¨ç°ä»£çš„å‰ç«¯ç¯å¢ƒä¸­ï¼Œå…¶è§£å†³æ–¹æ¡ˆå‡ ä¹å°±æ˜¯æ ‡å‡†åŒ–çš„â€”â€”Promiseã€‚ä½œä¸ºå¤æ‚å¼‚æ­¥é€»è¾‘çš„ä»£è¡¨ï¼Œæˆ‘ä»¬äº†è§£äº† Promise çš„å·¥ä½œåŸç†ï¼Œç”šè‡³æ‰‹å†™äº†ä¸€ä¸ª Promise å‡ºæ¥ã€‚å®ƒè¿˜å¸¦æœ‰ä¸€ç³»åˆ—èƒ½å¤Ÿææ•ˆçš„é™æ€æ–¹æ³•ã€‚

Promise åœ¨å¦‚ä»Šå·²ç»è¶Šæ¥è¶Šå¾—åˆ°é‡ç”¨ï¼Œæ¯”å¦‚ async/awaitã€Generator éƒ½æ˜¯å¼ºç»‘å®š Promise çš„ã€‚ä¸€äº› APIï¼Œæ¯”å¦‚ `geolocation.getCurrentPosition`ã€`window.getScreenDetails`ï¼Œä»¥åŠ Node.js ä¸Šçš„æ–‡ä»¶æ“ä½œ APIï¼Œäº¦æˆ–æ˜¯ `dynamic import`ï¼Œéƒ½æ˜¯ä»¥ Promise å¤„ç†å¼‚æ­¥çš„ã€‚