æåˆ°å¾®ä»»åŠ¡ï¼ˆ`microtask`ï¼‰å’Œå®ä»»åŠ¡ï¼ˆ`macrotask`ï¼‰ï¼Œç½‘ä¸Šèƒ½æ‰¾åˆ°ä¸€å¤§å †æ–‡ç« ï¼Œå¤§è‡´è§‚ç‚¹æ˜¯ï¼š

> 1.  å®ä»»åŠ¡åŒ…æ‹¬ `setTimout`ã€`setInterval`ã€`setImmediate`ã€`requestAnimationFrame` ç­‰ï¼Œå¾®ä»»åŠ¡åŒ…æ‹¬ `process.nextTick`ã€`Promise`ã€`MutationObserver`ã€`queueMicrotask`ç­‰ï¼›
> 2.  å¾®ä»»åŠ¡æ¯”å®ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜ï¼›
> 3.  å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡å„è‡ªå†…éƒ¨ä¹Ÿæœ‰ä¼˜å…ˆçº§ã€‚

æˆ‘å°±å¾ˆå¥½å¥‡ï¼Œå¦‚æœè¯´å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡å„è‡ªå†…éƒ¨ä¹Ÿæœ‰ä¼˜å…ˆçº§çš„è¯ï¼Œé‚£ä¹ˆå®ƒä»¬è¿˜å±äºä¸€ç±»ä»»åŠ¡å—ï¼Ÿæˆ‘æ·±å…¥åœ°äº†è§£äº†ä¸€ä¸‹ï¼Œå‘ç°äº‹å®è¦è¿œæ¯”åŒºåˆ†å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡è¦å¤æ‚å¾—å¤šã€‚äºæ˜¯å³ä¾¿æœ‰é‚£ä¹ˆå¤šæ–‡ç« è®²å®ƒä»¬ï¼Œæˆ‘è¿˜æ˜¯å†³å®šåœ¨å°å†Œä¸­åŠ ä¸Šæœ¬èŠ‚å†…å®¹ï¼Œå’Œå¤§å®¶ä¸€èµ·æ‹æ¸…ä¸åŒå¼‚æ­¥ä»»åŠ¡çš„æœ¬è´¨ï¼Œæœªæ¥ä¸è‡³äºçº ç»“äºç”¨å“ªä¸ª APIã€‚

æ¦‚å¿µï¼šä»€ä¹ˆæ˜¯å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡
-------------

æˆ‘æ‰¾éäº†å„ç§è§„èŒƒæ–‡æ¡£ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°å¯¹äºå¾®ä»»åŠ¡å’Œå®ä»»åŠ¡çš„ä¸¥æ ¼å®šä¹‰ã€‚å½“ç„¶ä¹Ÿä¸æ˜¯æ¯«æ— æ”¶è·ï¼Œæµè§ˆå™¨å’Œ Node.js éƒ½æ”¯æŒä¸€ä¸ª API å«åš `queueMicrotask`ï¼Œå®ƒåœ¨ `whatwg` æ˜¯æœ‰[è§„èŒƒ](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#microtask-queuing "https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#microtask-queuing")çš„ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€å¥è¯ï¼š

> EachÂ [event loop](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop "https://html.spec.whatwg.org/multipage/webappapis.html#event-loop")Â has aÂ microtask queue, which is aÂ [queue](https://infra.spec.whatwg.org/#queue "https://infra.spec.whatwg.org/#queue")Â ofÂ [microtasks](https://html.spec.whatwg.org/multipage/webappapis.html#microtask "https://html.spec.whatwg.org/multipage/webappapis.html#microtask"), initially empty. AÂ microtaskÂ is a colloquial way of referring to aÂ [task](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task "https://html.spec.whatwg.org/multipage/webappapis.html#concept-task")Â that was created via theÂ [queue a microtask](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask "https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask")Â algorithm.

å¤§æ„æ˜¯ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—å°±æ˜¯å¾®ä»»åŠ¡çš„é˜Ÿåˆ—ï¼ˆqueueï¼‰ï¼Œè€Œå¾®ä»»åŠ¡å°±æ˜¯é€šè¿‡å¾®ä»»åŠ¡å…¥é˜Ÿé€»è¾‘è€Œåˆ›å»ºçš„ä»»åŠ¡ã€‚æœ‰æ²¡æœ‰ä¸€ç§ GNU å¼çš„é€’å½’å³è§†æ„Ÿï¼Ÿ

æˆ‘è®¤ä¸ºè¿™ä¸ªè§„èŒƒä¸­çš„ä¸‹é¢è¿™å¥è¯æ›´æœ‰æ„ä¹‰ï¼š

> TheÂ `queueMicrotask()`Â method allows authors to schedule a callback on theÂ microtask queue. This allows their code to **`run once theÂ JavaScript execution context stackÂ is next empty, which happens once all currently executing synchronous JavaScript has run to completion`**.

æ³¨æ„ååŠéƒ¨åˆ†åŠ ç²—é«˜äº®çš„ä¸€å¥è¯ã€‚ç”±æ­¤æˆ‘ä»¬å¯çŸ¥ï¼Œè™½ç„¶æ²¡æœ‰æ˜ç¡®çš„å®šä¹‰ï¼Œä½†å¾®ä»»åŠ¡å°±æ˜¯æŒ‡é‚£ç§ **`å½“å‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œåç«‹åˆ»å°±å¯ä»¥è¿è¡Œçš„ä»»åŠ¡`**ã€‚ä»è¿™ä¸€ç‚¹ä¸Šæ¥è¯´ï¼Œå®ƒç¡®å®æ˜¯â€œé«˜ä¼˜çš„â€ï¼Œç”šè‡³å¯ä»¥å‘æŒ¥å‡ºé˜»å¡æ•ˆæœï¼š

    let i = 0;
    
    function run() {
        queueMicrotask(() => {
            run();
        });
    }
    
    run();
    
    // å§‹ç»ˆè¢«å¾®ä»»åŠ¡é˜»å¡ï¼Œå¾—ä¸åˆ°æ‰§è¡Œ
    setTimeout(() => {
        console.log('timeout');
    }, 100);
    

é‚£ä¹ˆå¯ä»¥æ¨æ–­å‡ºæ‰€è°“å®ä»»åŠ¡å°±æ˜¯éå¾®ä»»åŠ¡äº†ï¼Œä¸è¿‡è§„èŒƒä¸Šç¡®å®å®Œå…¨æ²¡æœ‰å®ä»»åŠ¡çš„ä»»ä½•å­—æ ·ã€‚å¯ä»¥çœ‹å‡ºï¼Œå®ä»»åŠ¡ã€å¾®ä»»åŠ¡æ˜¯ä¸€ç§æ¯”è¾ƒç²—ç³™çš„åˆ†ç±»æ–¹æ³•ï¼ŒåŒä¸€ç±»å‹ä¸‹çš„ä¸åŒä»»åŠ¡ä¹Ÿæœ‰å…ˆåä¹‹åˆ†å°±ä¸éš¾ç†è§£äº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°†å¸¦ç€å¤§å®¶é€šè¿‡â€œå¼•ç»æ®å…¸â€çš„æ–¹å¼æ¢³ç†ä¸åŒå¼‚æ­¥ä»»åŠ¡çš„å·®å¼‚ï¼Œä¸å†æ‹˜æ³¥äºä»…ä»…åˆ’åˆ†å®ä»»åŠ¡ã€å¾®ä»»åŠ¡çš„çŸ¥è¯†ã€‚æ³¨æ„ï¼Œè¿™ä¸€éƒ¨åˆ†çŸ¥è¯†ä¹Ÿå¸¸å¸¸æ˜¯ä¸€äº›é¢è¯•é¢˜çš„æ¥æºã€‚

åœ¨æ­¤ä¹‹å‰å‘¢ï¼Œæˆ‘ä»¬å…ˆå›åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—çš„æ¦‚å¿µä¸Šæ¥ï¼Œä¸Šé¢æœ‰æåˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å±äºäº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰çš„ã€‚

äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰
----------------

äº‹ä»¶å¾ªç¯æ€ä¹ˆç†è§£ï¼Ÿæˆ‘ä»¬è¯•æƒ³åœ¨ä¸€ä¸ªå•çº¿ç¨‹çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœè¦å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿæ˜¾è€Œæ˜“è§ï¼Œä½ å¿…é¡»å‘¨æœŸæ€§æ£€æŸ¥å„ä¸ªä»»åŠ¡çš„ä¿¡å·ï¼Œè¯¥æ‰§è¡Œä»£ç äº†å°±åˆ†é…æ—¶é—´å»æ‰§è¡Œå¥½äº†ï¼Œè¿™å°±æ˜¯å¾ªç¯ã€‚

ä¸åŒç³»ç»Ÿçš„äº‹ä»¶å¾ªç¯æœ‰è¾ƒå¤§å·®å¼‚ï¼Œæ¯”å¦‚æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯æ˜¯éµå¾ªåˆšæ‰æåˆ°çš„ `whatwg` [è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model "https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model")çš„ï¼Œæˆ‘æ‘˜å½•æ¯ä¸€æ­¥çš„æ ‡é¢˜ï¼š

1.  LetÂ `oldestTask`Â andÂ `taskStartTime`Â be null.
2.  If theÂ event loopÂ has aÂ task queueÂ with at least oneÂ runnableÂ task, then:
3.  Perform a microtask checkpoint
4.  LetÂ `hasARenderingOpportunity`Â be false.
5.  LetÂ `now`Â be theÂ unsafe shared current time.
6.  IfÂ `oldestTask`Â is not null, then:
7.  Update the rendering
8.  If all of the following are true
9.  If this is aÂ worker event loop, then:

æ³¨æ„ç¬¬ä¸‰ç‚¹å°±æ˜¯å¾®ä»»åŠ¡åœ¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œçš„æ—¶æœºï¼Œç”±æ­¤å¯æ¨æ–­è¯¥äº‹ä»¶å¾ªç¯è¿˜æœ‰çš„å¦ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆtask queueï¼‰å°±å¯ä»¥ç†è§£æˆå®ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚

ä»è¿™ä¸€ç‚¹ä¸Šæ¥çœ‹ï¼Œå¾®ä»»åŠ¡å¹¶ä¸ä¸€å®šéƒ½æ¯”â€œå®ä»»åŠ¡â€æ›´æ—©æ‰§è¡Œï¼Œåº”è¯¥è¿™æ ·æè¿°æ›´å‡†ç¡®ï¼š`æ¯æ‰§è¡Œä¸€æ¬¡å®ä»»åŠ¡ï¼Œç´§æ¥ç€å°±å»æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡`ã€‚

å½“ç„¶è¿™åªæ˜¯æµè§ˆå™¨çš„æ¨¡å‹ï¼Œå’Œæµè§ˆå™¨ç›¸å…³çš„å¼‚æ­¥ API æœ‰ï¼š`setTimout`ã€`setInterval`ã€`requestAnimationFrame`ã€`Promise`ã€`MutationObserver`ã€`queueMicrotask`ã€‚

è‡³äº Node.jsï¼Œæˆ‘ä»¬ä¸å¾—ä¸æåˆ° `libuv`ï¼Œå®ƒæ‰æ˜¯ Node.js å®ç°å¼‚æ­¥ IO çš„å…³é”®æ¨¡å—ã€‚è¿™æ˜¯å®ƒçš„äº‹ä»¶å¾ªç¯ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58a9c9b497ef4e99873e8280631fbd43~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=458&h=856&s=55821&e=png&b=f5f5f5)

æœ‰æºç ä¸ºè¯ï¼š

    int uv_run(uv_loop_t* loop, uv_run_mode mode) {
        int timeout;
        int r;
        int can_sleep;
    
        r = uv__loop_alive(loop);
        if (!r)
        uv__update_time(loop);
    
        if (mode == UV_RUN_DEFAULT && r != 0 && loop->stop_flag == 0) {
            uv__update_time(loop);
            uv__run_timers(loop);
        }
    
        while (r != 0 && loop->stop_flag == 0) {
            can_sleep =
                uv__queue_empty(&loop->pending_queue) &&
                uv__queue_empty(&loop->idle_handles);
    
            uv__run_pending(loop);
            uv__run_idle(loop);
            uv__run_prepare(loop);
    
            timeout = 0;
            if ((mode == UV_RUN_ONCE && can_sleep) || mode == UV_RUN_DEFAULT)
                timeout = uv__backend_timeout(loop);
    
            uv__metrics_inc_loop_count(loop);
    
            uv__io_poll(loop, timeout);
    
            for (r = 0; r < 8 && !uv__queue_empty(&loop->pending_queue); r++)
                uv__run_pending(loop);
    
            uv__metrics_update_idle_time(loop);
    
            uv__run_check(loop);
            uv__run_closing_handles(loop);
    
            uv__update_time(loop);
            uv__run_timers(loop);
    
            r = uv__loop_alive(loop);
    
            if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)
            break;
        }
    
        if (loop->stop_flag != 0)
            loop->stop_flag = 0;
    
        return r;
    }
    

æ€»ä¹‹ï¼Œ`libuv` çš„äº‹ä»¶å¾ªç¯ä¸­è‡³å°‘æœ‰ timerã€pending callbackã€idle handleã€prepare handleã€check handleã€close handle ç­‰ä¸åŒé˜¶æ®µï¼Œå› æ­¤å¤„äºé˜¶æ®µçš„å›è°ƒå‡½æ•°æ‰§è¡Œçš„æ¬¡åºä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚

Node.js æ¶‰åŠçš„å¼‚æ­¥ API æœ‰ `setTimout`ã€`setInterval`ã€`setImmediate`ã€ `process.nextTick`ã€`Promise`ã€`queueMicrotask`ã€‚

æœ‰äº†äº‹ä»¶å¾ªç¯çš„æ¨¡å‹åï¼Œæˆ‘ä»¬æŠŠ API å¯¹å·å…¥åº§ï¼Œå³å¯æ¨æ–­å‡ºå®ƒä»¬çš„æ‰§è¡Œæ¬¡åºã€‚Node.js åŒ…å«äº† `setImmediate`ã€ `process.nextTick` è¿™ä¿©æµè§ˆå™¨ä¸å…·å¤‡çš„èƒ½åŠ›ï¼Œæ›´å…·å…¸å‹ã€‚

Node.js ä¸‹çš„å¼‚æ­¥å›è°ƒ
--------------

Node.js ä¸Šçš„ `setTimeout/setInterval` å®ç°ä¸æµè§ˆå™¨æœ‰æ‰€ä¸åŒï¼Œä» TypeScript ç±»å‹ä¸­å°±èƒ½çœ‹å‡ºæ¥ã€‚å¦‚æœå¤§å®¶æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥ä¸‹è½½ Node.js æºç ï¼Œåœ¨ _src/lib/timers.js_ ä¸­å°±èƒ½çœ‹åˆ°å®ƒä»¬çš„ä»£ç ã€‚

æ²¡é”™ï¼Œå®ƒä»¬åœ¨æœ€å¤–å±‚ç¡®å®æ˜¯ç”± JavaScript ç›´æ¥ç¼–å†™çš„ï¼š

    function setTimeout(callback, after, arg1, arg2, arg3) {
        validateFunction(callback, 'callback');
    
        let i, args;
    
        switch (arguments.length) {
            // fast cases
            case 1:
            case 2:
                break;
            case 3:
                args = [arg1];
                break;
            case 4:
                args = [arg1, arg2];
                break;
            default:
                args = [arg1, arg2, arg3];
                for (i = 5; i < arguments.length; i++) {
                    // Extend array dynamically, makes .apply run much faster in v6.0.0
                    args[i - 2] = arguments[i];
                }
                break;
        }
    
        const timeout = new Timeout(callback, after, args, false, true);
    
        insert(timeout, timeout._idleTimeout);
    
        return timeout;
    }
    

> ğŸ’¡ ä¸¤ä¸ªæœ‰è¶£çš„äº‹å®ï¼š
> 
> 1.  setTimeout å’Œ setInterval åº•å±‚éƒ½æ˜¯ Timeout æ¨¡å‹ï¼Œåªæ˜¯ repeat å‚æ•°ä¸åŒï¼›
> 2.  clearTimeout å’Œ clearInterval æ˜¯é€šç”¨çš„ã€‚

é¡ºç€ _insert_ ç»§ç»­æ‰¾ï¼Œå‘ç° JavaScript ä¸ C++ å­˜åœ¨ç›¸äº’è°ƒç”¨ï¼š

    void SetupTimers(const FunctionCallbackInfo<Value>& args) {
        CHECK(args[0]->IsFunction());
        CHECK(args[1]->IsFunction());
        auto env = Environment::GetCurrent(args);
    
        env->set_immediate_callback_function(args[0].As<Function>());
    
        env->set_timers_callback_function(args[1].As<Function>());
    }
    

æœ€ç»ˆå¯ä»¥å‘ç° _set\_timers\_callback\_function_ å’Œ _set\_immediate\_callback\_function_ åˆ†åˆ«ä¸ `uv_timer_start` å’Œ `uv_check_start` ç›¸å…³è”ã€‚

ä¸€ç®­åŒé›•ï¼Œé€šè¿‡è¿½è¸ªä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥è®¤å®šï¼ŒNode.js ä¸Šçš„ `setTimeout/setInterval` å±äº timer é˜¶æ®µçš„ä»»åŠ¡ï¼Œè€Œ `setImmediate` å±äº check é˜¶æ®µçš„ä»»åŠ¡ï¼Œæ ¹æ®å‰é¢æåˆ°çš„äº‹ä»¶å¾ªç¯çš„æ¬¡åºï¼Œä¸‹é¢ä»£ç è¾“å‡º _1 2_ åº”è¯¥å°±å¯ä»¥ç†è§£äº†ï¼š

    setTimeout(() => console.log(1));
    
    setImmediate(() => console.log(2));
    

> ğŸ’¡ å½“ç„¶ï¼Œè€ƒè™‘åˆ°å®šæ—¶å™¨çš„ç‰¹æ€§ï¼Œå¦‚æœå½“å‰è¿›ç¨‹æ¯”è¾ƒç¹å¿™ï¼Œå…ˆæ‰“å° 2ï¼Œåæ‰“å° 1 ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚

æ¥ä¸‹æ¥çœ‹ `process.nextTick`ã€`Promise`ã€`queueMicrotask`ã€‚åä¸¤è€…å’Œæµè§ˆå™¨æ˜¯å…±äº«çš„ï¼Œéµå¾ªçš„æ˜¯ `whatwg` çš„è§„èŒƒã€‚è€Œäº‹å®ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå®ƒä»¬ä¿©æ˜¯ç”± v8 è€Œä¸æ˜¯ Node.js å®ç°çš„ï¼Œè¿™æ ·å°±å…¼é¡¾æ”¯æŒäº† Node.js å’Œæµè§ˆå™¨ä¸¤ä¸ªå¹³å°ã€‚ä½†åŒæ—¶å®ƒä»¬ä¹Ÿå°±ä¸å±äº `libuv` äº‹ä»¶å¾ªç¯ä¸­çš„ä»»ä½•é˜¶æ®µäº†ã€‚é‚£ä¹ˆå®ƒä»¬æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œå‘¢ï¼Ÿ

åœ¨ Node.js çš„æºç ä¸­ï¼Œ`queueMicrotask` å¯ä»¥è¿½æº¯åˆ° _src/node\_task\_queue.cc_ ä¸­çš„ `EnqueueMicrotask` å‡½æ•°ï¼š

    static void EnqueueMicrotask(const FunctionCallbackInfo<Value>& args) {
        Environment* env = Environment::GetCurrent(args);
        Isolate* isolate = env->isolate();
    
        CHECK(args[0]->IsFunction());
    
        isolate->GetCurrentContext()->GetMicrotaskQueue()->EnqueueMicrotask(isolate, args[0].As<Function>());
    }
    

è¿™é‡Œå°±èƒ½çœ‹åˆ°ä¼¼ä¹æœ‰ä¸€ä¸ªå…¨å±€çš„`å¾®ä»»åŠ¡é˜Ÿåˆ—`ï¼Œç»§ç»­è¿½ï¼Œå°±è¿›å…¥åˆ°äº† v8 ä¸­ï¼š

    v8::MicrotaskQueue* Context::GetMicrotaskQueue() {
        i::Handle<i::Context> env = Utils::OpenHandle(this);
        Utils::ApiCheck(env->IsNativeContext(), "v8::Context::GetMicrotaskQueue",
                    "Must be calld on a native context");
    
        return i::Handle<i::NativeContext>::cast(env)->microtask_queue();
    }
    

ç°åœ¨æˆ‘ä»¬åè¿‡æ¥ï¼Œå¯»æ‰¾è¿™ä¸ªé˜Ÿåˆ—ä»€ä¹ˆæ—¶å€™ä¼šè¢«æ‰§è¡Œï¼Œçœ‹ï¼š

    void PerformCheckpoint(v8::Isolate* isolate) override {
        if (!ShouldPerfomCheckpoint()) return;
        PerformCheckpointInternal(isolate);
    }
    

åœ¨ _src/node\_task\_queue.cc_ æœ‰è°ƒç”¨ï¼š

    static void RunMicrotasks(const FunctionCallbackInfo<Value>& args) {
        Environment* env = Environment::GetCurrent(args);
        env->context()->GetMicrotaskQueue()->PerformCheckpoint(env->isolate());
    }
    

ç»§ç»­å‘ä¸Šï¼Œæ˜ å°„åˆ° _lib/internal/process/task\_queues.js_ï¼š

    function runNextTicks() {
        if (!hasTickScheduled() && !hasRejectionToWarn())
            runMicrotasks();
        if (!hasTickScheduled() && !hasRejectionToWarn())
            return;
    
        processTicksAndRejections();
    }
    

æ³¨æ„ï¼š`runMicrotasks` åœ¨ `runNextTicks` å’Œ `processTicksAndRejections` ä¸­éƒ½æœ‰è°ƒç”¨ï¼Œè€Œåè€…åˆè¢«å‰è€…è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å…³æ³¨ `runNextTicks` å³å¯ã€‚

`runNextTicks` è¿™ä¸ªåå­—æ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ï¼Œæˆ‘ä»¬ä¸çŸ¥ä¸è§‰ï¼Œåˆå¼€å§‹å’Œ `process.nextTick` äº§ç”Ÿäº†è”ç³»ï¼Œåˆä¸€æ¬¡ä¸€ç®­åŒé›•ï¼

æˆ‘ä»¬æ¥çœ‹åœ¨ _lib/internal/timers.js_ ä¸­ï¼Œ`runNextTicks` éƒ½æœ‰å“ªäº›æœºä¼šè¢«è°ƒç”¨ã€‚

1.  é¦–å…ˆæ˜¯åœ¨ **processImmediate** ä¸­ï¼Œå³æ¯æ¬¡ `setImmediate` è¿è¡Œä¹‹åï¼›
2.  å…¶æ¬¡æ˜¯åœ¨ **processTimers** ä¸­ï¼Œå³æ¯æ¬¡ `setTimeout/setInterval` åˆ°æœŸä¹‹åã€‚

æˆ‘ä»¬å·²ç»çŸ¥é“äº† `setTimeout/setInterval` å’Œ `setImmediate` åœ¨ `libuv` çš„ timer å’Œ check é˜¶æ®µï¼Œæ‰€ä»¥èµ·ç å¯ä»¥è®²ï¼š**`queueMicrotask` ä»»åŠ¡åœ¨äº‹ä»¶å¾ªç¯çš„ timer å’Œ check é˜¶æ®µè¢«è°ƒç”¨**ã€‚è¿™æ ·çš„è¯ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰æ‹¿åˆ°çš„å®šä¹‰è¿˜æ˜¯æœ‰ä¸€å®šå‡ºå…¥çš„ï¼Œæˆ‘è®¤ä¸ºå‰é¢æŠŠå¾®ä»»åŠ¡å®šä¹‰æˆ`åŒæ­¥ä»£ç æ‰§è¡Œå®Œ`å°±è¦æ‰§è¡Œçš„ä»»åŠ¡è¿˜æ˜¯æ¯”è¾ƒæ¨¡ç³Šçš„ï¼Œæˆ–è€…è¯´å®ƒåªæ˜¯æè¿°äº†åŸºæœ¬ç°è±¡ï¼Œå…·ä½“æ‰§è¡Œè¿˜æ˜¯è¦ä»¥å®é™…ä»£ç å®ç°ä¸ºå‡†ã€‚

ä»”ç»†è§‚å¯Ÿ `runNextTicks` çš„æºç ï¼Œå‘ç°åªè¦æœ‰è®¡åˆ’ä¸­çš„ _tick_ï¼Œéƒ½ä¼šèµ°åˆ° `processTicksAndRejections` è¿™ä¸ªå‡½æ•°ã€‚å®ƒé‡Œé¢å¼•ç”¨çš„å˜é‡ _queue_ æ­£æ˜¯ `process.nextTick` æ“ä½œçš„æ•°æ®ç»“æ„ã€‚

æ‰€ä»¥æœ‰ç†ç”±ç›¸ä¿¡ï¼Œ**`process.nextTick æ€»æ˜¯ä¼šåœ¨ runMicrotasks ä¹‹å‰è¿è¡Œï¼Œä½†å®ƒä»¬å¹¶ä¸å±äºåŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—`**ã€‚

é‚£ä¹ˆ Promise å‘¢ï¼Ÿå—é™äºç¯‡å¹…ï¼Œæˆ‘è¿™é‡Œç›´æ¥è¯´ç»“è®ºï¼š**`Promise å’Œ runMicrotasks å…±äº«å¾®ä»»åŠ¡é˜Ÿåˆ—`**ã€‚å¤§å®¶æ„Ÿå…´è¶£å¯ä»¥ç¿»ä¸€ç¿» v8 çš„ä»£ç ã€‚

è®²äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ Node.js ä¸‹çš„å„ç§å¼‚æ­¥ API ç‰¹æ€§ï¼š

`setTimeout/setInterval` åœ¨ `libuv` çš„ timer é˜¶æ®µï¼Œä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­æœ‰ä¸¤æ¬¡æœºä¼šï¼›`setImmediate` åœ¨ `libuv` çš„ check é˜¶æ®µã€‚è€Œ `queueMicrotask` å’Œ `Promise` ä¸å±äº `libuv` äº‹ä»¶å¾ªç¯ï¼Œå®ƒä»¬æ‰æ˜¯ç”± v8 å®ç°çš„çœŸæ­£çš„å¾®ä»»åŠ¡ï¼›`process.nextTick` å’Œå¾®ä»»åŠ¡å¹¶ä¸å±äºåŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä½†å®ƒä»¬æ€»æ˜¯ä¸€èµ·ä¼šåœ¨ timer å’Œ check é˜¶æ®µä¸­æŒ‰å…ˆåæ¬¡åºæ‰§è¡Œã€‚

ç©ºå£æ— å‡­ï¼Œæˆ‘ä»¬ç”¨å‡ æ®µä»£ç æ¥éªŒè¯ä¸€ä¸‹ã€‚

å…ˆæ¥ç²—ç•¥éªŒè¯ `queueMicrotask` å’Œ `Promise` çš„ç­‰ä»·æ€§ï¼š

    // 1 2
    queueMicrotask(() => console.log(1));
    Promise.resolve().then(() => console.log(2));
    
    // 2 1
    Promise.resolve().then(() => console.log(2));
    queueMicrotask(() => console.log(1));
    

è°å…ˆåˆ›å»ºï¼Œè°å…ˆæ‰§è¡Œï¼Œç¬¦åˆå…±äº«åŒä¸€é˜Ÿåˆ—çš„åŸç†ã€‚ä¸‹é¢ä»¥ `queueMicrotask` ä½œä¸ºå¾®ä»»åŠ¡çš„ä»£è¡¨ï¼Œå’Œ `process.nextTick` è¾ƒé‡ä¸€ä¸‹ï¼š

    // 2 1
    queueMicrotask(() => console.log(1));
    process.nextTick(() => console.log(2));
    

å§‹ç»ˆéƒ½æ˜¯ `process.nextTick` å…ˆæ‰§è¡Œã€‚ä¸è¿‡å¤§å¤šæ•°æ—¶å€™ï¼Œå¦‚æœä½ ä¸æ··ç”¨å®ƒä»¬çš„è¯ï¼Œè¿˜æ˜¯å¯ä»¥è®¤ä¸ºå®ƒä»¬æ˜¯é€šç”¨çš„ï¼Œå‚è€ƒ Node.js çš„[æ–‡æ¡£](https://nodejs.org/dist/latest-v18.x/docs/api/process.html#when-to-use-queuemicrotask-vs-processnexttick "https://nodejs.org/dist/latest-v18.x/docs/api/process.html#when-to-use-queuemicrotask-vs-processnexttick")ï¼Œæ¯•ç«Ÿæ˜¯ç´§æŒ¨ç€çš„ä¸€å…ˆä¸€åã€‚

è‡³äº `queueMicrotask` ä¸ `setTimeout/setInterval/setImmediate` å°±ä¸å¿…å¤šè¯´äº†ï¼Œå¾®ä»»åŠ¡æœ‰æ›´å¤šçš„æ‰§è¡Œæœºä¼šã€‚ä»è¿™é‡Œæ¥çœ‹ï¼ŒåŠé—´å¯¹â€œå®ä»»åŠ¡â€çš„å«æ³•åº”è¯¥å°±æ˜¯æŒ‡ `libuv` çš„ä¸åŒé˜¶æ®µï¼Œè€Œå¾®ä»»åŠ¡åˆ™æ˜¯é˜¶æ®µä¹‹ä¸‹ç»´åº¦çš„ä¸œè¥¿ã€‚

> ğŸ’¡ ä¸€ä¸ªæœ‰æ„æ€çš„äº‹å®æ˜¯ï¼Œprocess.nextTick å’Œ setImmediate åœ¨å‘½åå’ŒèŒè´£ä¸Šä¼¼ä¹ç›¸åäº†ã€‚

å†™åœ¨æœ€å
----

å…³äºç½‘ä¸Šäººäº‘äº¦äº‘çš„å†…å®¹ï¼Œæˆ‘ç»™åˆ°å¤§å®¶çš„å»ºè®®æ˜¯ä¸å¯ä¸ä¿¡ï¼Œä¹Ÿä¸å¯å°½ä¿¡ï¼Œå¸¸è¨€é“çœ¼è§ä¸ºå®ã€‚å¯¹äºå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ç»è¿‡ä¸€ç•ªæºç çº§åˆ«çš„æ·±ç©¶å·²ç»çŸ¥é“ï¼Œå…¶å®å¹¶æ²¡æœ‰â€œå®ä»»åŠ¡â€çš„æ¦‚å¿µã€‚

ä½†å¾®ä»»åŠ¡æ˜¯ç°å®å­˜åœ¨çš„ï¼Œå¹¶ä¸”ç”± v8 å®ç°ï¼Œåœ¨æµè§ˆå™¨å’Œ Node.js ä¸Šæš´éœ²å‡ºäº† `queueMicrotask` å’Œ `Promise` å…¥å£ã€‚æœ¬æ–‡ä¸»è¦æ¢è®¨äº† Node.js ç¯å¢ƒçš„å¼‚æ­¥ï¼Œå¤§å®¶æœ‰å…´è¶£ä¹Ÿå¯ä»¥å»ç¿»é˜… Chrome çš„æºç ï¼Œæ¯”å¦‚[è¿™é‡Œ](https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/dom/mutation_observer.cc "https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/dom/mutation_observer.cc")å°±èƒ½çœ‹åˆ° MutationObserver ä¹Ÿæ˜¯å¾®ä»»åŠ¡çš„ä¸€ç§ã€‚

è‡³äº `setTimeout/setInterval` ä»¥åŠ `setImmediate`ï¼Œéƒ½å¯ä»¥å½’ç±»ä¸º `libuv` äº‹ä»¶å¾ªç¯çš„ä¸€ç¯ï¼Œè¿™æ ·å°±èƒ½ç†è§£å…¶å›è°ƒæ¬¡åºäº†ã€‚