前面我们讲了二进制，讲了数据类型，那么这些东西都是怎么跑起来的呢？

其实，`代码就是用控制语句操作数据类型，实现自己的逻辑，然后交给计算器去执行`。其大概流程就是：**我们用高级语言写的代码** -> **编译成机器代码** -> **读入内存中** -> **CPU 执行**。

这一系列操作需要调动 IO、控制器、运算器、寄存器、程序计数器等元件。我们就挨个来了解下这些元件的作用。

计算机的元件
------

众所周知，计算机是由`控制器`、`运算器`、`存储器`、`输入设备`、`输出设备`这五部分组成的，其中输入设备就是键盘和鼠标，输出设备就是显示器，这我们都见过了，那么控制器、运算器、存储器又是啥呢？CPU 又是啥玩意儿呢？我们来一一揭晓。

### 控制器

> 控制器是 CPU 的一部分，用来控制程序的执行流程。

**程序计数器就是控制器的一部分**。我们的代码被编译为机器码之后，就是从上到下逐行执行的，那么要执行哪一行，就是程序计数器来控制的。

比方说，我写了如下代码：

    int a = 10;
    int b = 10;
    int c = a + b;
    

那么，执行起来大概是这样：

![211676823144_.pic.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5bb92e0cb4a448bb945471fa5fe60a1d~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=458&h=238&s=18944&e=png&b=fcfcfc)

在代码的执行过程中，每执行一行代码，程序计数器就会加 1，当执行的指令占据多个内存地址时，就会增加与指令长度相应的数值。然后，控制器就会参照程序计数器的数值，从内存中读取命令并执行。也就是说，程序计数器决定着程序的流程。

比如上述，程序计数器指向 0100 地址时，CPU 就读取这一行的指令，也就是：“将 a 读入寄存器”；由于这一行指令只占用一个内存地址，所以程序计数器只加 1，变成 0101；接着 CPU 就读取下一个地址 0101，然后将 b 读入寄存器；如此反复执行，直到程序结束。

### 运算器

> 运算器也是 CPU 的一部分，它和控制器共同组成 CPU。

运算器的职责很简单，就是执行运算，比如上面的指令，执行到 0102 时，就需要将 a 和 b 相加，这个时候，运算器就会将两个寄存器的值，也就是 a 和 b 执行加法操作，然后将结果放入寄存器中，以备执行下一步。

运算器的原理很简单，就是使用我们高中都学过的门电路，举个例子，我们都知道按位与操作是：两个都为真才为真，那么，运算器怎么实现这个逻辑运算呢？

很简单，我们使用“串联”电路，我们构造一条电路，上面有多个开关，开关闭合表示“真”，开关打开表示“假”，这样，当所有开关都闭合，也就是所有条件都是“真”时，灯泡才亮，我们就当灯泡亮表示真，这就达到了“全真才真”的目的。同样的，或操作就可以使用“并联”电路，只要有一个开关闭合，也就是只要有一个条件为真，灯泡就会亮，这也达到了或操作的“一真则真”的目的。

用计算机来表示就是 1 表示灯泡亮，也就表示真；0 表示灯泡灭，也就是表示假。真是巧妙的设计！

有人说，运算器不是从内存中读数据的吗，怎么是从寄存器读数据呢？这跟我理解的不太一样啊。

### 寄存器

> 寄存器是在 CPU 内的，也是 CPU 的一部分。

因为寄存器是 CPU 的一部分，所以 CPU 从寄存器读写数据非常快，其实，我们通常说的：CPU 从内存中读数据，就是把数据读入寄存器中，但是我们的数据不是直接从内存读入寄存器的，而是先读入一个高速缓存中，然后才读入寄存器的。

这是为啥呢？因为从内存中读数据太慢了。

你可以这么理解：CPU 先把数据读入高速缓存中，以备使用，真正使用的时候，就从高速缓存中读入寄存器；当寄存器使用完毕后，就把数据写回到高速缓存中，然后高速缓存再在合适的时机将数据写入到存储器。

CPU 运算速度非常快，而从内存读数据非常慢，如果每次都从内存中读写数据，那么势必会拖累 CPU 的运算速度，可能执行 100s，有 99s 都在读取数据。为了解决这个问题，我们就在 CPU 和存储器之间放了个高速缓存，而 CPU 和高速缓存之间的读写速度是很快的，CPU 只管和高速缓存互相读写数据，而不管高速缓存和存储器之间是怎么同步数据的。这样就解决了内存读写慢的问题。

举个例子就是：我每次去书架拿书都很费劲，于是我就直接从书架把书取下来，放在我桌子上，这样就不用频繁去书架取了，等到读完了，就再把桌子上的书送回书架即可。

那这样有个问题啊，如果别人也想要书架上的那一本书怎么办？

问得好！这就是多线程问题，其实解决方案很简单，就是一个同步问题，要么你等我看完了再看，要么就多弄几本。这个问题我们在后面的操作系统部分再详细展开。

程序的执行流
------

经过上面的说明，我们大致了解了程序的执行过程：**我们的代码先被编译成一条一条的指令，要执行的时候就先读入高速缓存，然后将要执行的指令地址放在程序计数器中，控制器控制着这些指令按序执行，遇到数据就读入寄存器来让运算器执行，执行完毕后就放回寄存器执行下一条，全部执行完毕后就把数据写回高速缓存，高速缓存在合适时机就将数据同步回内存。**

唉，等等等等，这好像不对啊，程序不一定是按顺序执行的，比如遇到`if-else`语句呢？遇到`return`语句呢？还会按顺序执行吗？

肯定不会，其实程序的执行流程可以分为：**顺序执行、条件分支和循环执行**这三种。

### 条件分支和循环

考察如下代码:

    int a = 2;
    int b = 10;
    int c;
    if(a > 3) {
       c = a + b;
    }else {
       c = 2 * a;
    }
    

这个例子中有个条件分支，代码肯定不会顺序执行，那我们来看它是怎么执行的。

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/223aaf86b0d245ea86fdfe7aaec10971~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=501&h=310&s=27973&e=png&b=fcfcfc)

我们看到，在执行到指令 0102 时候，由于不满足`a>3`这个条件，就直接跳转到 0104 这个指令去执行了；而且，计算机很聪明，如果它在编译期间发现 a 永远不可能大于 3，它就会直接删除 0103 这条指令，然后，0104 这条指令就变成了下一条指令，直接顺序执行，也就是编译器的优化。

那么，计算机怎么知道 a 是不大于 3 呢？很简单，做减法，计算机使用 a-3，发现结果小于 0，就知道 a 小于 3 了。

**计算机中的比较操作，就是做减法，结果大于 0 就是大于，结果小于 0 就是小于，结果等于 0 就是相等**。

其他的循环语句和跳转语句，也是类似的过程，这里不多废话。

上面我们讲的都是单个函数，那么如果是多个函数互相调用呢，会是什么样的结果呢？

### 函数的调用流程

函数的调用需要用到函数的调用和返回指令，我们看个例子：

    int a = 10;
    int b = 11;
    
    void int sum(int a, int b) {
        return a + b;
    }
    

代码的执行过程大概是如下这样：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84e90a6377054279bf4dde6abcf3f839~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=561&h=360&s=38989&e=png&b=fcfcfc)

这里执行函数的时候，使用的是`call`指令，而不是`if-else`中的跳转指令，我们要注意，**call 指令和 return 指令总是成对出现的，也就是说：有函数调用，就有函数返回**。

`call`指令会把调用函数后的下一条指令存入栈中，然后执行函数逻辑，在函数执行完后，`return`指令会把栈中的下一条指令弹出，并写入程序计数器中，这样就接着执行下一条指令了。又因为 call 和 return 是成对出现的，所以即使多个函数调用嵌套调用，也不会出现问题。

比如上述例子中，在执行到 0102 时候，`call`指令就把 0103 压入栈中，接着执行函数逻辑；当执行完毕后，`return`指令就把 0103 这个再弹出写回到程序计数器，这样程序计数器就接着执行 0103 对应的指令，程序就按照我们的逻辑执行了。如此一来，程序的执行非常有序且流畅。

机器指令
----

其实，CPU 的处理流程很简单，就是按照给定的指令去执行，CPU 的指令有以下几种。

*   **数据传送指令**：执行数据的读取操作，比如从寄存器读数据，将数据写入寄存器。
    
*   **运算指令**：执行算数运算和逻辑运算，比如加法运算，按位与运算，比较运算。
    
*   **跳转指令**：条件分支、循环、跳转等操作。
    
*   **调用/返回指令**：函数调用/返回操作。
    

这些指令可能包含很多汇编指令，但是就是这么几种类型，只要用以上这些指令，就能完成所有的程序流程。是不是很简单呢？

总结
--

本章我们讲解了控制器、运算器、寄存器的作用，以及程序的工作流程，其实，所有这些都可以用简单的几条指令来概括，我们只需要了解其原理即可，不必死记硬背。

指令类型

功能

数据传送指令

执行数据的读取操作，比如从寄存器读数据，将数据读入寄存器等

运算指令

执行算数运算和逻辑运算，比如加法运算，按位与运算，比较运算等

跳转指令

条件分支、循环、跳转等操作

调用/返回指令

函数调用/返回操作

那么，下一节，我们就来看下该怎么优化我们的程序流，以让代码变得更高效。