在上一章中，我们讲了并发的发生和解决方案：**破坏同一时间或破坏同一目标**。我们知道，并发是两个线程之间的问题，那么进程之间呢？到底是哪个进程先跑，哪个进程后跑呢？CPU 是怎么安排这些进程的执行呢？

这就涉及到**进程的调度**了，我们本章就来看看 CPU 是怎么处理这些琐事的。

调度算法
----

> 调度算法指的是：CPU 对进程进行资源分配所采取的策略。

比如：全班有 40 个学生，每个学生都写了一篇作文，那么，老师先批改谁写的呢？

老师说：我就按照交作业的顺序来批改，这是一种调度算法。或者说：按照历史成绩名次来批改，这也是一种调度算法。

好，我们就把计算机处理的任务称作：**作业（Job）**，那么，计算机的调度算法就是处理这些作业的策略。

### 先来先服务

> 先处理先到达的。

先来先服务的意思就是：**先处理先到达的作业**。

这个很简单，就像我们[第 10 章](https://juejin.cn/book/7196580339181944872/section/7196589848277286946 "https://juejin.cn/book/7196580339181944872/section/7196589848277286946")讲的队列一样，先入先出。谁先到达，就先处理谁，也就是谁先到达，CPU 就先执行谁。

这无疑是非常公平的。但是却有很大缺点，比方说：我有个作业很长很长很长，CPU 不吃不喝大概要 10 个小时才能搞完，而这个作业正好是第一个到达的，那么，在这 10 个小时内，后面来了 10086 个小作业，每个小作业大概几秒就能搞完，于是乎，这 10086 个小作业就坐在那儿傻等着，等 CPU 都转冒烟了才轮到自己。10 小时后，后面的小作业看着那个 10 小时的长作业奸笑着走了。

这明显是不合适的。我就运行几秒的速度你让我等 10 个小时？等价于我为了看 1 分钟的电视剧就要看 10 个小时的广告，你这是电视剧插广告呢，还是广告插电视剧呢？

这明显是谁的执行时间长，谁沾光啊，所以，**先来先服务算法对长作业有优势**。

不行，得改！

你看这样可以吗？让小的先执行，反正也就几秒的功夫。

可以试试。

### 短作业优先

> 哪个作业小，先执行哪个。

现在我聪明了，执行作业的时候先看看作业的大小，小的优先执行，大的就往后排。这样一来，短期内我可以执行完好多个小作业，不用再被一个长作业卡死了。

这还是不行啊。那个 10 小时的长作业看着眼前的小作业一个一个执行完美滋滋地走了，心理很不服气，我先来的，凭什么不给我执行！如果前面有 100 个小作业，每个 1 小时，那我岂不是要等 100 个小时，你这跟 1 个 100 小时的长作业有啥区别？

它说的有道理啊，况且这个 10 小时的长作业是老大指定的，不能让人家等太久了。

那要怎么办呢？

嗯，加权。我们可以给每个作业都加一个权重，权重大的作业就特别照顾下，让它优先执行。

### 高优先权优先

> 给每个作业加权，权重大的优先执行。

我们按照每个作业的重要程度来设置权重，权重大的作业就优先安排执行。

还是上面的例子，那个长达 10 小时的大作业来了，刚想让它排队，一看权重是最高级的，那么就让它插个队，优先执行它，这不就跟银行的贵宾服务一样吗，随便插队。

如果两个优先级一样的，我们可以再按照先来先服务执行，或者短作业优先执行。

当然，对于作业的权重，我们还可以动态设置。

比如：有 A、B 和 C 三个作业，A 作业需要 10 个小时，权重是 5；B 作业需要 20 个小时，权重是 10；C 作业需要 15 个小时，权重是 8。那么，按照优先级来说，肯定是先执行 B，再执行 C，最后执行 A。结果在 B 执行完后，A 忍不住了，直接修改自己的权重为 10，此时，本来轮到 C 执行的，就变成了轮到 A 执行，那么 A 的这种权重就叫做**动态优先权**，而 B 和 C 的都叫做**静态优先权**。

> 静态优先权是事先设定好的，不会变的；动态优先权是可以随着时间改变的。

所以，我们在设计任务的时候，也可以借鉴这种方法，来动态地设置我们的优先权。比方说，我们在上一章谈到的**自适应自旋**，就是按照等待的时间自己调整自己的休眠时间，这跟动态优先权有异曲同工之妙。

那么，两个优先权一样，一个等了很久的长作业 A，一个刚到的短作业 B，我们应该先执行哪一个呢？

如果先执行 A，那么 B 可能等很久。如果先执行 B，那么 A 又要等很久。都不合适。

那么，有没有什么办法能把它们的等待时间和执行时间结合起来，从而得出一个数字来衡量下呢？

有！

### 高响应比优先

> 根据每个作业的等待时间和执行时间计算出响应比，响应比大的先执行。

宇宙的尽头都是量化，没有量化的推测就是耍流氓。

同理，我们上述说的全是些屁话，这里就把我们上述的废话量化成一个公式：

> **响应比 = (等待时间+执行时间) / 执行时间**

我们可以看到两点：

1.  等待的时间越长，响应比就越大，这就避免了短作业优先算法中长作业等得太久。长作业：谢谢你。
2.  执行时间越短，响应比越大，这就避免了先来先服务算法中短作业等得太久。短作业：谢谢你。

这就完美把`短作业优先`和`先来先服务`结合起来了。

看个例子：A（10 小时），已经等了 10 个小时；B（5 小时），已经等了 6 个小时；C（1 小时），刚到。

我们来计算下它们的响应比：

*   A = (10+10)/10 = 2
    
*   B = (6+5)/5 = 2.2
    
*   C = (0+1)/1 = 1
    

所以，我们应该先执行 B，此时 B 不是最先到的（A 先到），也不是最短的（C 最短），但是 B 却是响应比最高的，所以下一个就轮到 B 执行了。

其实，我们可以看到，**高响应比优先就是把短作业优先和先来先服务结合了起来，进行了个折中处理，用具体的数字量化出来**。只要有个确切数字，我们很容易就能决定谁先执行。

我们在日常的开发中，也要掌握这样一种思想：**把抽象的事物用具体的数字量化出来，根据数字来决定事情的优先级**。这样是最客观的，可以避免主观意识大于客观形态，从而减少感性决定。

### 时间片轮转

我们知道，电脑速度是很快的，那么，速度快有什么好处呢？很多！

我们可以这么理解：你说一句话的期间，我说了 1000 句话，不是跟一个人说了 1000 句话，而是跟 1000 个人每人说了 1 句话。

等等等等，那这不就意味着：1000 个人来找我搭讪，我可以同时搭讪这 1000 个人吗？

换句话说，1000 个作业来找我处理，我可以同时处理这 1000 个作业吗？

对！这就是**时间片轮转调度算法**。

> 给每个作业分配一小段时间执行，执行完了就让下一个作业执行。

我们可以按照作业的到达顺序排成一个队列，让前面的作业执行几毫秒，然后排到末尾，第二个作业再执行几毫秒，再排到末尾，直到作业执行完毕。

这样给人的感觉就是：每个作业都在执行，好像所有作业都在同步执行似的，这其实就是`并发`。

不是并行，是并发。

> 并行是指两个或者多个事件在**同一时刻**发生；而并发是指两个或多个事件在**同一时间间隔**发生。

比如：7 点整我在一边吃饭一边听音乐，这是一个**时间点**我在做两件事，那么这两件事就是并行的； 7 点到 8 点我写了作业洗了衣服，这是在一个**时间段**内我做了两件事，这就是并发。

**并行是真正的并行，而`并发是宏观上并行、微观上串行`**。

就像我写作业洗衣服，给人的感觉是：我在 7 点到 8 点之间，写作业的同时洗了洗衣服。实际上我不是同时干的，而是一件一件干的。

那么计算机呢，也不是同时干的，而是一件一件干的。但是因为执行得快，给人的感觉就像是：同时干的。

比如：人的反应时间是 500ms，计算机有 100 件任务，按照时间片轮转，一个执行 4ms 就执行下一个，那么，当你在时间 T 去问计算机你的任务执行到哪了，它说 10% 了。而下一次你去问的时候，已经过了 500ms 了（因为你的反应时间是 500ms），这个时候，计算机已经又执行一轮了，你的任务已经 20% 了。所以，给你的感觉就像是：它一直在执行你的任务。

这就是速度碾压！比金色闪光还金色闪光！

那么，我们要怎么使用这些调度算法呢？

调度算法实践
------

调度算法无处不在，只不过我们平常不注意罢了。

比方说，大家都写过下载逻辑，就像一个歌单：点击就下载。相信大部分人都是创建一个队列，点击的时候就将歌曲添加到队列中，然后按照顺序下载。这其实就是：**先来先服务**。

还有一种下载器，用户可以手动拖放下载位置，也就是可以把后面的拖到前面，或者采用“置顶”来让后面的跑到前面去，这就是**高优先权优先**。

其实，如果是后台下载的时候，我们可以采用**短作业优先**，因为放在后台的话，指不定啥时候就被系统杀死了，如果是长作业，可能下载到一半，就没了；但是如果是短作业，那么还能下载完几首歌曲，这肯定是更好的。

当然，如果是专门做下载器的同学，比如迅雷，当任务比较多的时候，采用**高响应比优先**是更好的策略，这样不至于让用户等太久，也不至于半天一个都没下载完。

其实，京东、淘宝的客服，它们采用的就是加权的高响应比优先算法，也就是说：**在高响应比优先的公式里，加上用户的权重**，权重指的就是你的会员等级等重要程度指标。只不过这个不是计算机用来调度进程，而是用来调度人力罢了，所以，这些调度算法不仅仅适用于撸码，还适用于生活。

总结
--

本节我们讲解了计算机的调度算法，其实就是一个思想：**将所有可行的方案列出来，将影响它们的条件量化成一个数字，然后按照这个数字去决定**。

*   先来先服务：先到达的先执行。
*   短作业优先：耗时少的先执行。
*   高优先权优先：优先级高的先执行。
*   高响应比优先：结合等待时间和执行时间计算响应比，响应比高的先执行。
*   时间片轮转：每个都执行一小段时间，直到所有作业都执行完。

操作系统的基础到这里就结束了，下一章，我们就进入计算机网络的世界，来了解下计算机网络是怎么搭建起来的。