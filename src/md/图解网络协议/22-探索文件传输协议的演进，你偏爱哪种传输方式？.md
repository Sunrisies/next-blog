文件传输一直是一个古老的需求，从最早的`FTP`（文件传输协议）到如今的云存储服务和存在争议的 P2P 文件传输方式。在计算机网络出现之前，人们使用可移动`介质`（如磁带、磁盘、磁片等）将文件从一台计算机复制到另一台计算机，这种方式耗时且需要手动操作。

随着计算机网络的发展，文件传输变得更加快捷和便利。1960 年代，美国国防部研究项目`ARPANET`的出现，标志着计算机网络的雏形开始形成。在`ARPANET`上，人们可以通过`FTP`在不同的计算机之间传输文件。`FTP`是一种客户端-服务器协议，允许用户通过`FTP 客户端`连接到`FTP 服务器`，上传和下载文件。`FTP`的出现比`HTTP`还要早！

随着互联网的普及，文件传输方式也不断演进。除了`FTP`，人们还可以使用电子邮件、文件共享软件和云存储等方式进行文件传输。现在，人们可以通过各种设备和网络连接进行文件传输，如计算机、手机、平板电脑、Wi-Fi、4G、5G 等，这大大提高了文件传输的效率和`便利`性。

本文将介绍计算机网络中出现的一些`典型的文件传输协议`，首先让我们一起来看看古老的`FTP`。

FTP 的两种工作模式：深入了解
================

`FTP`利用两个 TCP 连接：`控制连接`和`数据连接`，以分离控制和数据传输，控制连接负责命令和响应，数据连接仅负责数据传输，避免了控制信息干扰，提高了可靠性和效率。

除了使用两个 TCP 连接之外，FTP 还有两种工作模式。现在我们可以通过搭建一个 FTP 服务来实现这两种模式，例如使用`vsftpd`实现 FTP 服务，该服务运行在 IP 地址为`43.156.20.160`的 FTP 服务器上，并默认监听在`21`端口。

以下是 Centos7 的实现步骤：

    $ yum install vsftpd
    $ useradd -d /home/ftpuser -m -s /bin/bash ftpuser
    $ passwd ftpuser
    $ echo hello >/home/ftpuser/hello.txt
    $ service vsftpd restart
    

现在，`vsftpd`服务已经启动，并且你可以检测到它正在监听`21`端口，记得防火墙要放开`21`端口。同时，我们还创建了一个名为`ftpuser`的用户，并在其主目录下新建了一个名为`hello.txt`的文件，以供后续实验使用。

常见操作系统都支持 FTP 客户端，例如在 MAC 操作系统中可以连接 FTP 服务器，如下图所示。输入正确的用户名和密码后，就可以成功连接并开始共享`hello.txt`文件。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/800169e8f5474fb3b63aa301de620c71~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2135&h=1478&s=347160&e=png&b=27282a)

通过运行`tcpdump -A -i any host 43.156.20.160`来捕获数据包，从中可以观察到一些数据包的交互。让我们来看看这些数据包的具体情况，包括两条 TCP 连接的详细信息。首先，可以看到过滤出的服务器的`21 端口`对应于`控制连接`。

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49257e11ea2f4243a2440d9e42392aad~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2658&h=1920&s=804511&e=png&b=1c1c1c)

如上图所示，通过控制连接（`21`端口），客户端一旦成功登录并与服务器交换基本信息后，客户端会请求`PASV`被动模式。接着，服务器选择了`随机端口48174`作为数据交互的端口。

被动模式是怎样运作的？
-----------

在 FTP 服务器处于被动模式时，它会向 FTP 客户端发送一条响应消息，其中包含了一个 IP 地址和`端口号`的组合，用于告诉 FTP 客户端可以连接到哪个地址和端口来传输数据。这个 IP 地址和端口号的组合被称为“数据连接”。客户端将连接到该端口以进行数据传输。在这次交互中，我们可以使用过滤条件`tcp.port==48174`来筛选相关数据包，如下图所示：

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9be637a1f2d14607a40a3d9af28dd37a~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=3358&h=1074&s=539478&e=png&b=1d1d1d)

客户端向服务器`端口 48174`发起连接，在三次握手成功后就有了一条数据连接，客户端通过控制连接发出`LIST`命令，服务器将通过数据连接将这个目录信息返回，和`HTTP`一样，我们看到`FTP 也是明文`的。如上图我们看到的那样，可以看到被动模式的工作方式如下：

    客户端                                服务器
      |      建立控制连接（端口21）      |
      |--------------------------------->|
      |                                |  
      |        开放随机端口N作为数据通道   |
      |<---------------------------------|  
      |                                |  
      |      端口N连接请求（随机端口）    |
      |--------------------------------->|
      |                                |  
      |              开始传输数据          |
      |<================================>|
    

需要注意的是，服务器在使用被动模式时会随机选定一个端口，因此防火墙策略也要相应调整。由于端口是随机的，服务器端需要放开`1024-65535`范围内的所有端口。然而，因为互联网充满风险，所以被动模式的安全性较低。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b32dcf11ab174d7ba11918d543c90c2b~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1924&h=212&s=32504&e=png&b=fefefe)

放开 `FTP` 服务器的`防火墙规则`允许客户端通过 FTP 协议连接服务器进行数据传输，但这也带来一定的风险和安全隐患。如果 FTP 服务器只对内部网络提供服务，并已经有其他安全措施来保护 FTP 服务器，那么放开防火墙规则可能是可以接受的。但如果 FTP 服务器需要对外提供服务，尤其是在互联网上，`放开防火墙规则可能会面临来自网络攻击者的攻击`，包括恶意软件、端口扫描和暴力破解等。

主动模式是怎样运作的？
-----------

FTP 还支持`主动模式`，该模式与被动模式不同，它要求 `FTP 服务器主动发起数据连接`。在主动模式下，客户端会将自己的数据端口告知 FTP 服务器，然后服务器通过该端口连接客户端，并进行数据传输。与此同时，服务器发出连接的数据端口通常使用`固定的端口号 20`。

首先让我们看下怎么使用主动模式，我们可以使用`ftp -A host`命令发起主动模式的连接，如下图所示，就是主动模式的交互。

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f482a2ca549940b7ba07469634c07a53~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1338&h=854&s=121268&e=png&b=141414)

通过抓包可以看到，客户端向服务器传递了自己的数据端口号`39619`，然后服务器使用固定的`20 端口`向客户端的`39619 端口`发起了 TCP 连接。下图展示了该过程：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/37d679bd6094482ebe557fa64e5c6ff7~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=4320&h=1337&s=1532389&e=png&b=1c1c1c)

然而，主动模式并不被大多数客户端所接受，因为在现代网络环境下，它可能会遇到多种问题，其中最主要的是与 `NAT` 网络环境的兼容性问题。在 `NAT` 网络环境下，`FTP` 服务器无法向客户端发起数据连接，因为客户端的 IP 地址和端口可能已经被 `NAT` 路由器转换过了，`FTP` 服务器无法确定客户端的真实 IP 地址和端口。

这个问题导致`FTP 的主动模式`现在几乎被淘汰。

使用更安全和便利的文件传输
-------------

`FTP 的主动模式`现在几乎被淘汰，而使用`FTP 协议被动模式`进行文件传输需要防火墙开放很多端口，增加了网络攻击面，从而对网络安全带来风险。由于防火墙的限制，FTP 建议仅在内部网络（即局域网）中使用。因此，后来 FTP 已被各种`网盘产品`所取代，尤其是在网盘产品推出免费 T 级存储空间的时代。

现代浏览器不再默认支持 FTP 协议，因为 FTP 协议存在`安全隐患`，如`明文`传输、数据篡改、恶意软件等，容易被黑客攻击。虽然 FTP 仍可用于共享文件和数据，但已不是推荐解决方案，因为 FTP 不提供端到端加密，数据传输期间可能会被窃听或篡改，且存在多个安全漏洞。因此，现代企业通常使用更安全可靠的协议和工具，如`SFTP`、`SCP`、`WebDAV`等来共享文件和数据。

网盘产品：使用 HTTP 协议进行文件传输
=====================

`网盘`（也称为`云盘`）是一种基于`云存储技术`的在线文件存储服务，用户可以通过浏览器或专用客户端上传、下载、管理个人或企业文件。云存储是一种集中式的存储模式，用户的数据被存储在云服务器上，用户可以随时在任何地方通过网络访问这些数据。

比如，`COS`（Cloud Object Storage）是腾讯云提供的一种云存储服务，支持多种数据类型的存储，如图片、视频、音频、文本等。COS 提供了多种访问方式，包括`HTTP 和 HTTPS`协议，同时支持`SDK、API 和 CLI`等多种开发工具。COS 还提供了多种安全机制，如数据加密、权限管理等，为用户的数据安全提供了全面保障。

`HTTP`协议是网盘/COS 常用的一种文件传输方式。用户可以通过`浏览器`或专用客户端上传和下载文件。相比于 FTP，HTTP 具有更高的`灵活`性，也支持断点续传和加密传输等功能，这些能力提升了文件传输的便利性和安全性。

P2P：使用对等网络分享大文件
===============

网盘作为`中心化`的文件存储和分享方式，依赖于成千上万台机器的云存储后台。不同的云产品有不同的定位，有些用于备份存储，有些则用于分享。但我们无法避免担心数据丢失、上传下载速度慢等问题。

有些小型的网盘公司可能存在`数据丢失`的问题，而一些大公司的产品则可能`收费昂贵`或`限速`。下载速度可能会受到服务器带宽限制或产品本身的限制，即使有很多可以分享的资源，例如百度云盘，如果不充会员下载速度则较慢。

除了中心服务器的架构，互联网还有一种`分布式`的思想。全分布式的思想认为，文件不必上传到中央服务器，可以让用户之间`相互分享`。例如，如果 A 拥有一部电影并想与 B 和 C 分享，B 和 C 可以连接到 A 并下载文件块，同时 A 上传文件块给 B 和 C。另一方面，如果 B 拥有游戏并希望与 A 和 C 分享，A 和 C 可以连接到 B 并下载文件块，同时 B 上传文件块给 A 和 C。

这种技术或思想称作`P2P`（`Peer`\-to-`Peer`，即点对点），它是一种分布式计算或网络架构，其中没有中心服务器，而是由所有节点（或对等方）共同承担数据和计算的功能。每个节点都可以作为服务提供者和服务请求者，这样就实现了资源共享和去中心化的特点。P2P 网络常用于`文件共享`、`即时通讯`、`在线视频和音频`、`比特币`和`区块链`等应用。

但是，需要至少解决两个问题才能实现`P2P 的文件分享`：

1.  A 和 B 之间通信的问题，还有非常多的终端用户位于私有网络中，没有公网地址，需要解决 NAT 后的`peer 间的通信问题`；
2.  如何在互联网上发布或查找所需资源的拥有者的问题。虽然在小社区中，人们可以相互共享自己的地址（公网地址），但在互联网上，我们需要有一种办法找到发布或查找所需资源的拥有者。

让我们带着这两个问题，先一起来看下`BitTorrent`协议吧。

BitTorrent 文件共享协议
-----------------

`BitTorrent`是一种基于`P2P`技术的文件共享协议，它是在 P2P 网络上实现文件共享的一种方式。

`Bittorrent`这个名字来源于两个单词的组合。其中，“`Bit`”代表二进制数字，即计算机中最小的存储单位，而“`Torrent`”则表示一种猛烈的、急剧的流动，类似于洪水或暴雨。因此，“`Bittorrent`”这个名字可以理解为指代一种通过大量小的二进制数字块的猛烈、急剧流动来实现文件分享和下载的协议。

Bittorrent 协议的特点如下：

1.  **`分布式`结构**：Bittorrent 协议使用分布式结构，即每个用户都可以同时充当客户端和服务器，共享自己拥有的文件，并从其他用户下载所需的`文件块`。
    
2.  **超级节点**：Bittorrent 协议中存在一些特殊的节点，称为超级节点（`Seed`），它们拥有完整的文件，并且一直保持在线状态，以便其他用户下载。
    
3.  **协议扩展**：Bittorrent 协议支持许多扩展功能，如加密、`DHT`（分布式哈希表）、PEX（对等方交换）等，这些功能可以提高文件共享的效率和安全性。
    

在 `BitTorrent` 中，种子地址（也称为`磁力链接` ）是一个包含元数据的链接，它可以让用户快速获取特定文件的种子。这些元数据包括文件名、文件大小、文件哈希值等信息。使用种子地址，用户可以快速获取到要下载的文件。

在使用种子地址下载文件时，用户需要使用 `BitTorrent 客户端软件`，该软件可以通过种子地址获取到文件的元数据，并开始下载文件。

常见的 `BitTorrent` 客户端包括 `uTorrent`、`BitTorrent`、`Transmission` 等。下图正是`uTorrent`的操作界面：

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/974fb11eafd44a168e6545092b604ca9~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=3180&h=1812&s=497387&e=png&b=ffffff)

客户端的使用方法非常简单，主要包括两种方式：使用种子文件或添加链接来`下载所需的资源`，以及`分享自己的资源`（制作并分享种子文件）。

使用 STUN 实现内网穿透
--------------

首先，让我们看一下`P2P`中一个非常关键的问题：如何在`NAT 后的 peer 之间进行通信`？

由于`IPv4`的地址空间太小，许多终端设备（如家庭网络和校园网）都没有公共`IPv4`地址，因此我们和外界的通信都存在`NAT`问题。虽然让人欣慰的是现在许多运营商已经开始分配`IPv6`地址，使用`IPv6`进行通信不会出现`NAT`问题，但并非所有设备都有`IPv6`地址。仍然存在一些网络运营商不支持`IPv6`，或者某些设备不支持`IPv6`，导致`NAT`问题仍是不可忽视的。

为了让非公共网络中的两个客户端相互通信，有多种方式可供选择。其中一种方式是使用名为`STUN`（Session Traversal Utilities for NAT）的协议，该协议可以帮助终端设备在 `NAT` 路由器后面建立直接连接。当客户端尝试连接到使用 `NAT` 的网络时，它会向 `STUN 服务器`发送一个请求，以获取其公共 IP 地址和端口号。随后，STUN 服务器将响应包回送给客户端，以便客户端能够了解其`公共 IP 地址和端口号`，从而使得远程服务器和它进行通信。

有许多开源实现的 `STUN 服务器`可供我们实验，如下所示：

    $git clone https://github.com/jselbie/stunserver
    $cd stunserver
    $docker image build -t=stun-server-image .
    $docker container run -d  -p 3478:3478/udp --name=stun stun-server-image
    $docker exec -it stun bash
    

我们使用了`Github`上的一个开源 STUN 服务器，为了避免编译环境问题，可以`构建 Docker 容器`来运行。一旦运行成功，我们可以看到 STUN 协议使用`UDP`协议进行通信，默认端口为`3478`。当然还有公有的`STUN 服务器`可供我们直接使用，比如`stun.l.google.com`。

下面这个客户端位于公网上，可以使用该 Docker 容器内的`stunclient`工具来访问`stunserver`。

    # ./stunclient 43.156.20.160
    Binding test: success
    Local address: 172.17.0.2:36183
    Mapped address: 43.156.19.65:36183
    

处于容器网络内的进程发起请求，并最终获得公网地址`43.156.19.65:36183`。由于公网机器不存在 NAT 问题，因此`进程的端口号 36183`即为公网端口号，无需解决`NAT`问题。

现在我们来考虑一下如果客户端位于`NAT`后面的终端设备上会发生什么情况。下面这个客户端位于`NAT`后：

    # ./stunclient 43.156.20.160
    Binding test: success
    Local address: 172.17.0.2:36721
    Mapped address: 113.104.181.130:6784
    

`NAT`后的终端设备返回的端口是`6784`，与进程本身的端口`36721`不同，这也对应一条`NAT 表`中相应的映射。但要注意的是，由于`NAT`表的映射可能会被回收，因此在一段时间内（几分钟或数小时），对于同一进程端口，其对应的`NAT`映射的端口可能会有所不同。当`NAT`设备重新分配`IP`地址和`端口号`时，客户端需要重新发起`STUN 请求`来发现新的映射关系。因此，客户端应该设计成能够处理这种动态变化。

如下图所示一段时间后`NAT 端口`发生了变化，大约 5 分钟后，`NAT`的端口从`7808`变为了`8890`。

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72ccff70a3bd46af81c60e64375223ee~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1812&h=1434&s=476206&e=png&b=0e2b35)

这样我们就实现了`NAT 内网穿透`！应用程序只需访问`STUN`服务器，即可了解其公网地址。任何一台处于公网的服务器都可以扮演此`STUN 服务器`的角色，而且通常使用`UDP`交互。因为你会发现，`BitTorrent`协议交互几乎都使用`UDP`。

`BitTorrent`的实现需要支持所有`peer`，无论它们处于何种网络环境，因此 NAT 穿透是不可避免的主题，虽然具体实现可能不一定直接利用现有的`STUN`服务器。

在 P2P 网络中发现 peer
----------------

第二个问题是如何`发现 peer`，也就是在互联网上找到资源拥有者。

一个解决方法是提供一个`tracker`服务器，通过记录资源发布地址、上传和下载`peer`，来协调文件的上传和下载。这正是`BitTorrent`协议采用的方法。`Tracker`服务器是用于协调和管理 P2P 文件共享网络中连接的服务器，通常用于 `BitTorrent` 协议中，帮助下载者和上传者建立连接。通过`Tracker`服务器，下载者可以获取上传者的 IP 地址，以便建立连接并下载文件。

除了`tracker`，现在还有一种称为`DHT`（分布式哈希表）的发现方式。`DHT`是一种去中心化的技术，它允许对等网络中的节点相互通信和共享信息，而无需依赖于中央服务器。在`DHT`网络中，每个节点都可以充当一个“路由器”，负责转发其他节点的请求和响应。当一个节点需要连接到其他节点时，它可以使用`DHT`来查找其他节点的 IP 地址和端口号，并直接连接到它们，而不需要使用`tracker`服务器。目前`DHT`已经被广泛应用于 P2P 文件共享网络中。

可见，通过在`tracker/DHT`网络中注册并获取`peer`地址，将多个`peer`连接在一起，形成一个对等网络。而通过使用`STUN`协议，`peer`之间可以在不同的网络环境下，建立起可靠的连接并实现信息交换。这样，利用对等网络分享大文件就变得更加简便和高效了。

小结
==

本文探讨网络协议中的重要主题：`文件传输`。这包括历史悠久的`FTP`，以及在现今各种商业模式和法规监管（存在版权问题）下，如何使用`BitTorrent`传输。虽然公网和`IPv6`实现`P2P`不麻烦，但由于`NAT`的存在，需要借助`STUN`等技术支持。本文未详细讲述 P2P 的`tracker`和`DHT`的实现，希望在后续讲解网络寻路算法时进行更加深入的探讨。

尽管这些文件传输协议各有优缺点，例如即使最古老的 FTP 仍然有用处，而 P2P 虽然存在争议，但实际上仍然被广泛使用，网盘产品广泛用于备份和分享。你更倾向于哪种方式？