网络是一个虚拟的东西，它是看不见、摸不着的。我们前面讲到，网络`从上到下`依次包括：应用层、传输层、网络层、网络接口层。虽然我们已经着重讲了传输层，但传输层的网络是怎么形成的呢？

本文会沿着相反的方向，依次讲述网络接口层中的`物理层`、网络接口层中的`链路层`和`网络层`，让你对网络的形成有一个生动的印象。

网络分层看起来很抽象，但是如果`从形成的角度`来看却是非常有意思的。网络的形成是一步步的，就像人类从原始世界一步步过渡到现在的现代化世界一样。下面可以跟着我一起过一遍网络形成的过程吧！

物理层：从物理信号到比特流
-------------

物理层是经典计算机网络层次中最下面的一层，它负责将计算机0和1构成的比特流在各种传输介质上传输，为此物理层定义了传输媒介、电气特性、数据编码和传输速率等规范。物理层的表现形式非常丰富，现在看来大部分情况是电缆和光纤。第一根网线的出现可以追溯到一百年前出现的电话线。数据可以通过光信号（光纤）、电磁波（电线、无线电）等方式传输。

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd0c51565a9840f2812d9db8370af05f~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1211&h=511&s=222084&e=png&b=f4f6f8)

链路层通信：比特流转数据帧以及交换机的应用
---------------------

我们平时在打电话时可能会遇到这样一个问题：某一时刻双方都想向对方说话，结果声音互相干扰，谁也无法听清楚对方的内容。而用网线互联起来的计算机也会遇到这样的困扰，网线上同时传输的信号会互相干扰，接收方无法解码出原始的信号。链路层（Link Layer）的引入正是为了解决这一难题，使得相连的多个节点能够正确无误地互相传输数据。为此，链路层定义了数据帧的结构、数据传输方式、错误检测和纠正机制等规范，保证了在共享的传输媒介上可靠地传输数据。下面我们将大致介绍链路层时如何做到这一点的吧。由于`以太网`协议是我们平时最常用到的链路层协议，后续讲述皆以以太网为例进行讲述。

### CSMA/CD

首先要解决的是在共享介质上输出数据时的信号干扰问题。我们平时打电话时，为了能够顺畅交流，会尽量在对方不在说话的时候再说话；而如果不小心双方都开始说话了，就礼貌地让对方先说。与之类似的，以太网协议中一个非常重要的协议`载波侦听多路访问/冲突检测`（Carrier Sense Multiple Access/Collision Detection，CSMA/CD）协议也是使用类似策略保证计算机之间顺畅通讯的。具体来说，这个协议要求发送方：

1.  在发送数据之前监听链路，如果链路上没有任何信号，则认为链路为空闲，可以开始发送数据。
2.  如果链路上有其他设备正在发送数据，则发送方需要等待一段时间再重新检测链路，以避免数据冲突。
3.  如果发送的数据包与其他设备发送的数据包发生冲突，则发送方会停止发送并等待一段时间后再次尝试发送。此外为了让其他设备能够清楚地检测到此次冲突，发送方还会故意发送32~48bit的人为干扰信号。

### 数据帧

在一个和谐的多人视频会议中，如果某个人滔滔不绝的单方面输出，其他人出于礼貌只能默默倾听着，但会议就是要让所有参会者各抒所见的，需要保证每个人的发言权。同理，以太网协议为了保障每个设备的”数据发送权“，规定设备只能以数据帧的方式在链路上传输数据，且一个数据帧最大长度不能超过1500 字节，也就是我们常说的`MTU（`MTU是“最大传输单元”的缩写，是指在网络通信中可以发送的最大数据包大小）。如果一次传输的数据超过 MTU，则需要链路层将其分割并发送到物理层。

结合前面的”CSMA/CD“协议，以太网发送数据帧如下图所示：![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6dbdd630c5cd4942bb11e5f8f61602f7~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1180&h=686&s=62842&e=png&a=1&b=868e96)

*   A 网卡将待发送的数据按照一定大小拆分为帧。
*   A 发送第一个帧。
*   如果 B 检测到碰撞，B 会等待。
*   A 发送完一个帧后会停顿一段时间，一般可能是非常小的一段时间（具体的等待时间是根据设备到目的地的距离计算的 ），此时链路空闲。
*   B 检测到链路空闲后发送自己的的帧。

这样的话，**链路层的帧**解决了**链路独占**的问题。

另外，以太网还规定了数据帧必须大于64字节。这是因为如果数据帧太短，设备发送完数据帧之后，虽然和其他设备发送的数据帧冲突了，却检测不出来。就好比相隔很远的两人同时大吼了一声，由于声音的传播不是瞬时的，两人在大吼的时候都感知不到冲突，而位于两者之间的第三人却能听的出来。最小帧大小的限制，保证了设备在发送完数据帧前就能够检测到冲突。

### MAC地址

现实世界中的网络，不是将计算机用网线两两相连构成的，而是将计算机连接到一个共享的链路上，通过多路复用协议互相通讯（例如以太网协议）。那么当计算机的网卡收到链路上传来的数据帧时，怎么知道这个包就是发送给自己的呢？这就得为每个网卡设备分配一个地址信息，通过检查数据帧中的目的地地址信息来确认是否是发送给自己的。我们常说的网卡的MAC地址说的就是这个地址信息，MAC地址（Media Access Control Address）由网卡厂商预设的，通常是48位二进制数，用于识别链路层的数据帧从哪个设备发送和接收。因此每个网络设备都有一个唯一的MAC地址，这样数据帧就可以被正确地发送到目标设备了。

链路层的帧格式如下：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34849fe38a574e28a0a14e3a2221c77e~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1906&h=202&s=30804&e=png&a=1&b=000000)

可以看到每个帧中都会携带`目标 MAC 地址`（Destination MAC），用于将帧转发到目的地。

### 交换机

在交换机出现之前，我们使用一种叫做`HUB`网络设备将多个网络设备连接起来，使它们可以互相通信。HUB多很多个端口，既能连接计算机网卡，也能够连接其他HUB，借助HUB我们构建一个小小的局域网。HUB会将从一个端口接收到的数据包广播到所有其他端口上，因此所有设备都能够接收到这些数据包。HUB是网络技术中较为落后的设备，现在已经被交换机所取代。交换机从HUB发展而来，解决了以下两个问题：

1.  冲突问题： 在HUB上，当多个设备同时发送数据时，数据会冲突，导致数据包丢失或损坏。而交换机可以在数据包传输前，通过查找目标MAC地址，将数据包仅发送到目标设备所在的端口，而不是向所有的端口广播数据，从而避免了数据冲突问题。
2.  安全问题：在HUB上，所有设备都可以看到网络上的所有数据包，这使得数据包可以被任何设备截获并查看。而交换机可以将数据包仅发送到目标设备，从而提高了网络的安全性。

交换机本身没有 `MAC 地址`，其作用是帮助帧进行转发。交换机是怎么实现数据包转发的呢？交换机内部同时使用转发表（forwarding table）或者 MAC 地址表（MAC address table）来实现转发决策。转发表或者 MAC 地址表记录了网络设备的 MAC 地址与交换机端口号之间映射关系，交换机接收到数据帧后，根据目标 MAC 地址在表中查找对应的出端口，然后将数据帧转发到该出端口。在下图中，假设交换机通过1号端口连接的主机为A，通过3号端口连接的主机是B，那么其内部就会建立一个`{"A的MAC地址"：端口1, "B的MAC地址"：端口3}`的映射关系。很有意思的是，这个转发表或者MAC地址表是交换机自动构建的，不需要事先手动设定，感兴趣的读者可以去查阅相关资料，这里就不深入探讨了。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/28eb25cf6bdd44788d3fb7fff81d55ba~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1825&h=686&s=97692&e=png&a=1&b=868e96)

### 链路层的网络世界构成更大的部落

下图所示的交换机通过层级结构可以构建更大的网络：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30742a36904944f4b9bf7d9d201a1378~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1604&h=804&s=57944&e=png&a=1&b=868e96)

如果 A 需要将数据发送给 C，但 A 所连接的交换机没有记录 C 的 MAC 地址，那么 A 相连的交换机会将数据广播到所有其他端口，包括与其他主机相连的端口和与其他交换机相连的端口，直到找到 C 的 MAC 地址或者超时。这个过程称为广播风暴（broadcast storm），会造成网络拥塞和性能下降，但不会直接造成开销。因此，为了避免广播风暴，交换机连接的子网通常不宜过大，最好控制在几百个主机以下。

IP 层：网络 IP 层使用 32 位 IP 地址够了吗？
-----------------------------

实际的网络世界非常庞大，而交换机组成的网络只相当于一个个的小部落，如果想要在很多很多的小部落之间进行通信，路由会变得非常困难，故而产生了`网络 IP` 层。

### 网络范围扩张：部落-村落

交换机组成的网络世界相当于一个个的**小部落**，规模还是太小。我们人类的发展历史就是网络发展的最好的借鉴，部落还可以发展为村落嘛。

如下图：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc3c81b0d7f242a9b688a9130a49f34a~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2719&h=1693&s=243270&e=png&a=1&b=868e96)

*   多个部落（交换机的网络）构成了更大的**村落**；
*   村落之间可以通过路牌去识别部落，假设使用二进制数字来表示路牌，两位二进制可以表示这四个部落了，分别是 **00**、 **01**、 **10**和 **11**。

### 网络范围扩张：村落-更大区域

然而，网络还在继续发展，从村落发展为更大的区域。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f605d6b5c343443c9b3c6807d968b452~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=3200&h=1979&s=380894&e=png&a=1&b=868e96)

*   村落渐渐变多，发展成区域；
*   图上这里的**区域**同样可以用两位二进制作为路牌来路由到涉及的各个村落；
*   网络继续这样，**扩大范围并向前**发展，最终就构成了**全世界的网络**。

我们可以看到，现在网络已经足够大了，然而现实情况的网络比这个更密集、更复杂。

### IP 层次划分：住址和行政层级

我们的世界十分广阔而复杂，要找到一个人的住址，我们可以按照行政区划分级表示，从小组、村庄、乡镇、县区、市、省份、国家，乃至星球。

然而，在计算机网络中，我们使用 32 位的 `IP 地址`来表示网络地址，二进制的指数级增长也是很大的数字，32位这相当于可以表示全世界最多 4 亿个独一无二的 `IP 地址`。虽然 `IP 地址`没有行政区划那么形象，但就像我们之前比喻的那样，它天然自带`路由`含义。每个数字都有意义，某些二进制位可能代表某个层次，比如村庄、县区、城市等，如下图所示：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c44b4de567c45538c3eab9586f0a566~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=349&h=123&s=11268&e=png&b=ffffff)

与此不同的是，机器的 `MAC 地址`类似于身份证号码，但并不带有任何地址标识。

#### IPv4 地址

32 位的 `IP 地址`如果按照 8 位一组来划分则可以分成 4 组。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/749fce8a56e04e9d9cbf5fed817145b1~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1058&h=152&s=14486&e=png&a=1&b=c92a2a)

上面的地址就是一个 `IPv4 的地址`，**01101111.01111101.11111011.11110100** ，对于我们来说更友好的写法是用十进制表示，这个地址我们将其用十进制表示为**111.125.251.244**。

#### IP 地址分配

因为各个组织，比如国家，公司都是有内部结构的，他们可能会要求某一块网络地址都划分给自己。

考虑到这样的需求，当制定 IP 协议规范时，规范制定者对 IP 地址和网络做了 `ABC` 三类的划分和分配。

A 类地址的范围是 1.0.0.0 至 126.0.0.0，B 类地址的范围是 128.0.0.0 至 191.255.0.0，C 类地址的范围是 192.0.0.0 至 223.255.255.0。

*   `A 类地址`的前 8 位表示网络 ID，后 24 位表示主机 ID，由于网段里有 2^24 个地址，一般公司不需要这么多 IP 地址，导致很多主机地址没有被使用。这类地址一般被划分为国家或大型跨国公司。
*   `B 类地址`的前 16 位表示网络 ID，后 16 位表示主机 ID，其中特殊的地址包括 192.168.0.0 表示当前网络。这类地址一般划分给公司。
*   `C 类地址`的前 24 位表示网络 ID，后 8 位表示主机 ID，网络内可用的主机地址有 250 多个。一般认为家庭和小型企业可以有此网络。
*   此外，127.0.0.1 表示本机，全 0 主机 ID 的网络表示网络本身，全 1 主机 ID 的网络表示广播地址。

#### 私有的网络和 NAT

只是现在全世界的电脑台数远远不止 4 亿了，IP 地址已经不够用了，再加上上面讨论到的那些：IP 地址的分配方式和网络规模不匹配，导致 IP 地址的浪费，就更是 **IP 告急**了。

所以大部分时候，比如在**我们国家**，很多社区、公司和学校都会用到**私有网络**的方案。

*   你家里的网络，你公司的网络，都很有可能是私有的局域网内的地址。
*   在云上买的服务器，那可能是公有 IP 地址的。

如下面的对比图：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c047a1eefb14e0399f18e98c2fb9a5d~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2498&h=1549&s=206183&e=png&a=1&b=868e96)

由于公有网络的限制，本地网络中的主机在上网时需要多处理一层数据包（相比公网还需要进行一层转换）。例如，C 打开 QQ 聊天程序，并与家中的人进行聊天。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6982df0976a542c2bd56d14ff46f0094~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2849&h=883&s=164213&e=png&a=1&b=868e96)

在公有网络中，内网主机的数据包需要经过出口路由器进行 `NAT`（Network Address Translation）转换，将私有 IP 地址转换为公网 IP 地址，同时还需要修改 MAC 地址，以便数据包在公网上的传输和路由。

`NAT`（Network Address Translation），即网络地址转换，是一种在网络设备之间转换 IP 地址的技术。NAT 主要用于将内网中的私有 IP 地址转换为公网中的公有 IP 地址，或将公网中的公有 IP 地址转换为内网中的私有 IP 地址，以实现不同网络之间的通信。

在进行内网出口 NAT 转换时，出口路由器会在 NAT 表中保存一个映射关系，将内网主机的私有 IP 地址和端口号映射到出口路由器的公网 IP 地址和端口号上。当路由器收到从公网发来的数据包时，它会根据数据包的目的 IP 地址和端口号，查找 NAT 表中对应的映射关系，然后将数据包转发给对应的内网主机。这样，内网主机就能够接收到从公网发来的数据了。

可以通过[www.whatismyip.com/](https://www.whatismyip.com/ "https://www.whatismyip.com/")找到自己的公有IP地址。

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/536ff78f369640028774722a953e5482~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2113&h=665&s=997295&e=png&b=000e34)

#### IPv6

由于 `IPv4` 地址枯竭的原因，`IPv6` 的规范被制定者制定出来。IPv6 使用 128 位的地址，将每 16 位划分为一组，分成 8 组，这是一个非常大的数字，IP 地址的数量看起来就没有任何限制了。此外，IPv6地址分配是由Internet号码分配机构（IANA）分配给五个地区号码分配机构（RIRs），然后由RIRs再将地址分配给互联网服务提供商（ISPs）或终端用户。IPv6地址的分配看起来也更加科学合理了。 虽然全世界和我们国家的各种组织都在推动 IPv6 的规范，但是目前 IPv6 规范还没有完全普及。 本地可以通过`ifconfig`命令查看自己的IP地址，我本地展示的是：

    #ifconfig
    en1: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
    	options=6463<RXCSUM,TXCSUM,TSO4,TSO6,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>
    	ether 3c:a6:f6:75:41:7e
    	inet6 fe80::1461:4281:4d88:6107%en1 prefixlen 64 secured scopeid 0xd
    	inet 192.168.1.29 netmask 0xffffff00 broadcast 192.168.1.255
    	inet6 240e:3b2:32d1:94c0:546a:****:****:**** prefixlen 64 autoconf temporary
    	nd6 options=201<PERFORMNUD,DAD>
    	media: autoselect
    	status: active
            ...
    

本文比较抽象，较少实践的内容，但我也建议你亲自查看一下自己的网卡配置，同时查看下IPv4地址和IPv6地址，观察一下它们和公网查到的地址一致吗？欢迎在评论区留言。

总结
--

本文按照物理层、链路层和网络 IP 层的顺序描述，展示了连接全球计算机的过程。网络从最初的形态逐步演化成现代化的形式。如果你有任何疑问或建议，请在评论区留言。网络寻址是一个更加细节的问题，本文还未涉及。网络IP包相关的更多主题，我们还将在其他章节中进行探讨。