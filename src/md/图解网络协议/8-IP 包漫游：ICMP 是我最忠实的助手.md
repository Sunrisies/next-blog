本文继续探讨 `IP` 报文传递的故事，特别是 `ICMP 协议`的具体信息。之前我们提到了 `traceroute` 命令如何利用 `ICMP` 协议返回中间节点信息来达到自己的目标，现在我们将从更加微观的角度来讨论 `ICMP` 协议。

`ICMP` 包是一套用于传输、处理数据包错误和进行诊断的交互式信令。我们知道每个协议都有固定的格式，`ICMP 包`也不例外。它由 8 字节的头部和可选的数据部分组成。头部包含类型字段（`1 字节Type`）和代码字段（`1 字节Code`）两个字段，其余 6 个字节用于校验和、标识、序列号以及其他一些信息。下图展示了 `ICMP` 包的结构。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d31b197d8414fd5b7e98ffa7a4cd425~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2208&h=672&s=246036&e=png&b=fefefe)

详解 ICMP：深入了解它的类型，透视它的应用
-----------------------

ICMP 协议是 `IP 协议的助手`，通过一字节的类型和 一字节的代码这两个字段作为控制信息，来提供辅助。

### ICMP差错报文

首先让我们来看下类型为 3 的`差错报文`。`traceroute`正是利用`ICMP协议`的差错报文，这在之前也已经提到。`类型 =3` 是差错报文的标志，当 IP 包无法正常抵达目的地时，`ICMP` 可以通过这个类型和具体的代码信息回应发送方应用，告知为什么无法到达。网络异常的原因是多样性的，因此 `ICMP` 提供了多个代码，其中的几个如下表所示：

类型

代码

含义

3

0

网络不可达

3

1

主机不可达

3

2

协议不可达

3

3

端口不可达

`ICMP` 差错报文的 `差错代码` 主要包括网络不可达、主机不可达和端口不可达等多种原因。

*   `网络不可达`表示发出的数据包无法到达其目标，因为中间的路由器或网络段无法到达。
*   `主机不可达`表示发送的数据包无法到达其目标主机。这可能是由于目标主机未连接到网络、未正确配置或发生其他问题。
*   `端口不可达`表示发送的数据包无法到达其目标主机上的指定端口，因为该端口未开放或未被目标主机上的应用程序使用。
*   `协议不可达`表示发送的数据包无法到达其目标主机，因为指定的协议不可用或未被支持。这可能是由于目标主机不支持发送方使用的协议，或者由于中间路由器或网关不支持该协议。

当发生错误时，由中间路由器或网关构造好ICMP协议对应的 `type` 和 `code`值，返回给发送方`ICMP`消息，如下图所示返回的就是`端口不可达`。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8539089fdf24b7bba47259ae1f67090~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1244&h=242&s=69833&e=png&b=0e2b35)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54956830e4d64960b545e1c72b83f271~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2020&h=458&s=135961&e=png&b=292929)

### ICMP ECHO 报文

`ICMP` 有一种很常见的类型，叫做 `ECHO 报文`，分为请求和响应，其类型值分别对应 8 和 0，对应的`code` 代码值都是 0。而且此时`ICMP` 头部的`标识符`和`序列号`也能派上用场；标识符可以像 `TCP` 或 `UDP` 中的端口一样用于标识会话，而序列号则在每个 `ECHO` 请求发送时递增并在 `ECHO` 应答中返回相同的值。

你一定知道 `ping` 这个命令行工具吧，人们最喜欢用 `ping 命令`来检查两个终端之间的网络连通性。但你是否知道， `ping 工具`是利用了`ICMP` 的`ECHO` 报文来工作的呢？

#### 使用 `ping 命令`

`ping命令`发送`ICMP ECHO请求`并等待回复，以确认网络是否可达。下面在主机`9.134.77.*`的终端输入以下命令：

       
      #  ping 9.134.73.3
      
      
      #  ping baidu.com
    

上面我们测试了两个主机的连通性，`9.134.73.3`是当前局域网所在的一个主机，`baidu.com`是根据域名（如果已知主机名，则需要通过`名字解析服务 DNS` 获取主机对应的 `IP` 地址，我们后面会讲到）来请求其所在机器的联通。在`ping`的同时注意使用 `tcpdump` 来观察 `ping` 过程中我们 `IP 包请求和响应`的过程：`sudo tcpdump host baidu.com`。

#### ARP协议：IP对应的MAC地址

在同一局域网内，如果要进行通信，需要知道目标主机的`MAC地址`。而`IP地址`只是逻辑地址，在数据链路层需要使用`MAC地址`来实现通信。`ARP协议`就是用来将`IP地址`解析成对应的`MAC地址`的。

所以如果幸运，`ping` 测试过程中你还有可能观察到一些特殊的 `ARP 协议包`。`ARP 协议`也是 `IP` 的一个辅助协议，用于通过 `IP` 地址获得`机器的 MAC 地址`。我刚好幸运，捕获到的`ARP 协议包`如下图所示。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb125cb55e7046888544e2d037a48213~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1338&h=374&s=78411&e=png&b=1f1f1f)

`ARP 协议`通过发送广播数据包，在本地网络上寻找`目标 IP 地址`对应的`物理 MAC 地址`。当两台计算机通过共享介质（如以太网）或者 `Wi-Fi` 连接时，它们会交换 `ARP 协议信息`。如果一台机器想要找到一个 `IP` 地址的 `MAC 地址`，它就会首先向所有其他电脑发送一个`包含相应目的 IP 地址的 ARP 帧`。那个特定 IP 对应的电脑就会马上回复一个 `ARP 回复帧`，告知相应 `MAC地址`信息。

从图上可以看到，`广播的目的 MAC 地址`设置为`全0`。`ARP` 的广播频率是由它所在网络中的实施标准来决定的。一般情况下，`ARP 广播`可以在 1 分钟或 10 分钟之间发送。

但是，如果目标设备不在同一个局域网内，发送方设备会将数据包发送到其默认网关（通常是路由器），路由器会将数据包路由到目标设备所在的网络。在这种情况下，发送方设备不需要知道目标设备的`MAC地址`，因为它将数据包发送到路由器的`MAC地址`，路由器会负责将数据包传递给目标设备。

#### ECHO正常流程

回到正题，发送 `ECHO（ping） request` 的 `ping 请求`,很快就得到了正常的响应。让我们一起来看看抓到的请求和响应包。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd5406d65f8f469b839834f3a6ab30df~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1756&h=664&s=383357&e=png&b=212121)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63a2bfbd4589471c912c54ec1ee55dd8~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2530&h=1076&s=586801&e=png&b=232323)

从上图可以看到，`ECHO（ping） request`的 类型字段`type = 8`，而 `ECHO（ping） reply` 的 类型字段`type = 0`。这表明目标机器可达，也支持 ICMP 协议，而且发出了正确的回复reply。此外，我们看到有个`Identifier`字段，这个就是标志符，作用在于区分不同的ECHO请求和响应。一个序列号的一来一回便可以知道从请求到响应需要花费的时间（也就是我们之前经常提到的RTT）了。

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed507cbd55ab4c23acf1af20c4c4033a~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1250&h=302&s=94158&e=png&b=0e2b35)

在上图中，`RTT`的`最小/平均/最大/标准差`（标准差可以用来衡量数据的离散程度，即数据点相对于平均值的分散程度。标准差越大，数据点越分散；标准差越小，数据点越集中）分别是 `42.036/45.110/48.184/3.074 ms`。

#### PING不可达的原因

我们经常会遇到`ping` 不可达的问题，原因可能各不相同，我们这里可以做一个简单的分析。

1.  目标主机故障或不可用：如果目标主机出现故障或者不可用，就无法进行ping测试。
2.  目标主机防火墙屏蔽ping请求：有些目标主机可能会设置防火墙，屏蔽ping请求。这种情况下，我们可以尝试使用其他网络工具进行测试。
3.  本地网络连接问题：如果本地计算机的网络连接出现问题，可能会导致ping测试不可达。

以上是常见的一些导致ping测试不可达的原因。如果遇到不可达的情况，可以根据具体情况进行排查。

另外请你思考一下：`ping命令可以用于IPv6地址吗`？

IPv6 还可以继续使用 ICMP 吗？—ICMPv6
---------------------------

`IPv6` 仍然使用 `ICMP`（Internet 控制消息协议）来传递网络控制信息和错误消息。但是，`IPv6 ICMP 消息`的格式和功能与 `IPv4 ICMP` 消息略有不同。`IPv6 ICMP` 消息被设计为支持新的类型和代码以支持 IPv6 独有的功能，如`邻居发现`和`无状态地址自动配置`。

在 `IPv4` 中，`ICMP` 仅作为 IP 协议的辅助功能存在，即使没有 `ICMP`，也能正常发送和接收 IP 数据包，实现 IP 通信。而在 `IPv6 中，ICMP 的作用被放大，如果没有 ICMP，将无法正常进行 IP 通信`。特别是在 `IPv6` 中，因为 `ARP` 协议的地址长度不够，`ARP 协议定位 MAC 地址的功能被替换为 ICMP 邻居探索消息（Neighbor Discovery）`，并提供自动设置 IP 的功能。

### 捕获ICMPv6 包

同样的，我们可以获取 `ICMPv6` 包。类似于 `traceroute` 命令，我们使用 `traceroute6` 命令指定目标 `IPv6 地址`，例如： `traceroute6 2606:4700:3036::6815:4c5b`（通过`nslookup -query=AAA regexr.com`得到其IPv6地址为`2606:4700:3036::6815:4c5b`）

这个`IPv6 地址`由8组16进制数字构成，每组由4个16进制数字组成，其中双冒号(::)表示省略了一些0。`traceroute6`将显示从你的计算机到目标 IPv6 地址的路由路径和延迟。

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc1840d4fe8846d0bb9eab00ae79f9a0~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1522&h=644&s=183365&e=png&b=0e2b35)

测试另外一个地址 `traceroute6 2001:db8::1`，使用`tcpdump`捕获到的`ICMPv6 包`如下图所示。 ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ae51f94de48498cb812090cb7d3d0e7~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=3020&h=962&s=462632&e=png&b=232323)

`ICMPv6` 消息主要分为两类：一类是`错误消息`，一类是`信息消息`。0 - 127 属于错误消息；扩展的 128 - 255 属于信息消息。

`RFC 4443` 中描述了以下消息类型：

类型

信息

1

目标不可达 Destination Unreachable

2

数据包太大 Pachage Too Big

3

超时 Time Exceeded

4

参数问题 Parameter Problem

128

Echo Request

129

Echo Reply

`ICMPv6` 除了包含 `ICMPv4` 的所有功能外还有`两个额外的功能`：**邻居探索**和**组播收听发现协议**。

### ICMPv6 邻居探索——Ipv6 的 ARP

[RFC 4861](https://www.rfc-editor.org/rfc/rfc4861 "https://www.rfc-editor.org/rfc/rfc4861") 描述的是`邻居发现协议（Neighbor Discovery Protocol，NDP）`，它使用 ICMPv6 信息消息类型来实现邻居发现、地址解析、重定向等功能。

类型

信息

133

路由器请求消息 Router Solicitation

134

路由器公告消息 Router Advertisement

135

邻居请求消息 Neighbor Solicitation

136

邻居宣告消息 NeighborAdvertisement

`ICMP 邻居发现`（Neighbor Discovery）用于解决 `IPv6` 节点在通信时需要了解同一链路上其他节点的 `MAC 地址`的问题。节点可以发送 `ICMP` 邻居请求消息来查询目标节点的`MAC地址`，目标节点则会回复一个邻居回应消息来提供自己的 `MAC 地址`信息。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17b9cdc8207b4aea9b01eee269c3014d~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2451&h=926&s=194733&e=png&a=1&b=000000)

`邻居探索消息`对于 `IPv6` 通信起到举足轻重的作用。邻居请求消息用于查询 `IPv6 地址`与 `MAC 地址`的对应关系，并且利用 `IPv6 的多播地址`实现传输。

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40e5001a9a474fcf970b28ae9e32cfbc~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1104&h=366&s=116315&e=png&b=242424)

邻居发现协议还包括了其他功能，如地址自动配置和路由器发现等，它们都是 `IPv6` 网络中非常重要的组成部分。当 `IPv6` 主机连接到一个网络时，它会向网络中的路由器发送一个`路由器请求消息（Router Solicitation）`以获取网络前缀信息。路由器会回复一个`路由器通告消息（Router Advertisement）`，其中包含网络前缀和其他配置信息。主机可以根据这些信息自动配置自己的 `IPv6` 地址和其他网络参数。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e278d495e2fa401cb8cc281af6810875~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=2482&h=694&s=327885&e=png&b=262626)

### ICMPv6 的组播监听发现协议

另外我们可以了解一下ICMPv6 的组播监听发现协议。 [组播收听发现协议（MLD）](https://www.rfc-editor.org/rfc/rfc2710 "https://www.rfc-editor.org/rfc/rfc2710")通常用于 `IPv6` 网络中的组播传输，用于管理组播成员身份，以便组播路由器可以确定哪些主机对组播数据流感兴趣，并只将数据发送到感兴趣的主机。在多媒体流、视频会议、分布式应用、内容分发网络等需要实现组播传输的场景中都会使用 `MLD 协议`，达到节省网络带宽和提高数据传输效率的作用。

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/235d98950d0b408e814a5ec77ee147b9~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1036&h=226&s=219649&e=png&b=272727)

在使用 `MLD 协议`时，需要注意以下几点。

1.  主机需要支持 MLD 协议，并向组播路由器发送 MLD 报文，以表明它对某个组播组的兴趣。
2.  组播路由器需要支持 MLD 协议，并能够解析 MLD 报文，以确定哪些主机对组播数据流感兴趣。
3.  在组播数据流传输时，组播路由器会根据收到的 MLD 报文，只将数据发送到感兴趣的主机，以减少网络拥塞和带宽占用。
4.  MLD 协议需要与 IPv6 协议配合使用，因此在配置网络设备时需要考虑 IPv6 地址分配、路由配置等因素。

以下是一些应用实现了 MLD 协议：

1.  `视频会议系统`：在视频会议系统中，多个用户需要同时观看同一视频流，这可以使用组播技术来实现。
2.  `IPTV 系统`：IPTV 系统需要将视频信号通过 IP 网络传输到用户终端，这也可以使用组播技术来实现。
3.  `内容分发网络（CDN）`：CDN 系统通过在全球各地部署服务器，将内容缓存到离用户最近的服务器上，以提高访问速度和可用性。组播技术可以用于将内容从源服务器传输到各个缓存服务器上，以节省网络带宽和提高传输效率。

总结
--

在某些情况下，防火墙会禁用 `ICMP 协议`以提高网络安全性。攻击者可以利用 `ICMP` 泛洪攻击网络进行 `DoS` 攻击，利用 `ICMP` 探测网络中的存活主机进行 `Ping` 扫描攻击，或者使用 `ICMP` 消息传递恶意软件或攻击指令。因此，某些网络设备也可能禁用 `ICMP` 以提高性能或减少网络流量。

本章我们继续讲述了 `IP` 协议包的故事，其中讨论了 `ICMP` 协议在网络中的重要作用，同时介绍了 `ICMPv6` 协议在 `IPv6` 网络中的应用。此外，本章还涉及了 `ARP` 协议和 `DHCP` 服务器等信息，展示了 IP 协议的复杂生态。

`思考题`：除了类型为 3 的差错报文外，还有其他几种类型的差错报文。例如，在上一篇文章中提到的用于跟踪路由的 `type=11` 报文，表示 `TTL` 超过上限。`ICMP` 还有许多其他类型的报文，它们各自适用于不同的场景。如果你有兴趣了解更多细节，建议查阅相关的 [RFC 文件](https://www.rfc-editor.org/rfc/rfc792 "https://www.rfc-editor.org/rfc/rfc792")。你有了解到 `ICMP协议`哪些实用的功能或者工具？欢迎在留言区留下你的足迹。